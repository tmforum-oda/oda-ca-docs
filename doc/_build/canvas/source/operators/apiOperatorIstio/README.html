

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>API Operator for Istio/Prometheus - Introduction &mdash; ODA-Component Accelerator v1beta1 documentation</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="apiOperatorIstio module" href="apiOperatorIstio.html" />
    <link rel="prev" title="API Operator: Istio" href="modules.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> ODA-Component Accelerator
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">About the project:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/Playbook.html">Introduction to the ODA Component Accelerator Project (ODA-CA)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/Getting_started.html">Getting started checklist for new members of ODA-CA</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/Observability-Tutorial/README.html">Tutorial to deploy and observe a running component</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/ODAComponentTutorial/README.html">Tutorial to build ODA-Component from Open-API Reference Implemenation</a></li>
</ul>
<p class="caption"><span class="caption-text">Design Guidelines:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/ODAComponentDesignGuidelines.html">Design Guidelines to create a new ODA Component</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/ODACanvasDesignGuidelines.html">Design Guidelines to design an ODA Canvas</a></li>
</ul>
<p class="caption"><span class="caption-text">Compliance Test Kit (CTK):</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../ctk/README.html">ODA Component - CTK</a></li>
</ul>
<p class="caption"><span class="caption-text">Canvas Installation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/README.html">ODA Canvas installation</a></li>
</ul>
<p class="caption"><span class="caption-text">Canvas Usecase library:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../usecase-library/README.html">ODA Canvas - use-case library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usecase-library/index.html">ODA-Canvas - Usecase list</a></li>
</ul>
<p class="caption"><span class="caption-text">Canvas Operators:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Open Digital Architecture - Controllers/Operators</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../README.html">ODA Canvas Operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../componentOperator/modules.html">Component Operator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../apiOperatorSimpleIngress/modules.html">API Operator: SimpleIngress</a></li>
<li class="toctree-l2"><a class="reference internal" href="../apiOperatorApig/modules.html">API Operator: WhaleCloud API Gateway</a></li>
<li class="toctree-l2"><a class="reference internal" href="../apiOperatorWSO2/modules.html">API Operator: WSO2 API Gateway</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="modules.html">API Operator: Istio</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">API Operator for Istio/Prometheus - Introduction</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#istio-configuration">Istio configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#optional-configuration-for-datadog-using-pod-annotations">optional configuration for DataDog using pod annotations</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="modules.html#python-modules">Python modules</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../securityController/modules.html">Security Operator</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Troubleshooting Guide:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/TroubleshootingGuide/index.html">ODA-CA Troubleshooting Guide</a></li>
</ul>
<p class="caption"><span class="caption-text">Contributions Guide:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/ContributionsGuide.html">Contribution guidance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../docs/DocumentationProcess.html">Documentation Process</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">ODA-Component Accelerator</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Open Digital Architecture - Controllers/Operators</a> &raquo;</li>
        
          <li><a href="modules.html">API Operator: Istio</a> &raquo;</li>
        
      <li>API Operator for Istio/Prometheus - Introduction</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../../../_sources/canvas/source/operators/apiOperatorIstio/README.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="api-operator-for-istio-prometheus-introduction">
<h1>API Operator for Istio/Prometheus - Introduction<a class="headerlink" href="#api-operator-for-istio-prometheus-introduction" title="Permalink to this headline">¶</a></h1>
<p>This <strong>API operator</strong> for is designed to manage a Canvas environment that incluides the Istio Service Mesh as well as Prometheus monitoring and act as a reference implementation of an API Operator. In other canvas environment, (with a different combination of Service Mesh/API Gateway/Monitoring solution) the SRE (Site Reliability Engineering) team would need to write their own API Operator.</p>
<p>Both <strong>Istio</strong> and <strong>Prometheus</strong> can be configured using Kubernetes Custom Resource Definitions (CRD). The API Operators for Istio and Prometheus use the Kubernetes API to listen for changes to the CRDs and then configures Istio and Prometheus accordingly.</p>
<p>Istio uses <code class="docutils literal notranslate"><span class="pre">VirtualService</span></code> resources (https://istio.io/latest/docs/reference/config/networking/virtual-service/) to configure traffic routing in the Istio control plane.</p>
<p>Prometheus uses <code class="docutils literal notranslate"><span class="pre">ServiceMonitor</span></code> resources (https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/user-guides/getting-started.md) to configure the Prometheus monitoring system.</p>
<p>This makes the logic required to create an API Operator relatively simple. The API Operator listens for new/updated/deleted <code class="docutils literal notranslate"><span class="pre">oda.tmforum.org/API</span></code> resources and then creates/updates/deletes the corresponding Virtual Service and Service Monitor resources. The API Operator also listens for status updates from Istio and Prometheus and updates the status of the <code class="docutils literal notranslate"><span class="pre">oda.tmforum.org/API</span></code> resource accordingly.</p>
<p><img alt="API Operator" src="http://www.plantuml.com/plantuml/proxy?cache=no&amp;src=https://raw.githubusercontent.com/tmforum-oda/oda-ca/master/controllers/apiOperatorIstio/sequenceDiagrams/apiOperatorIstio.puml" />
<a class="reference external" href="sequenceDiagrams/apiOperatorIstio.puml">plantUML code</a></p>
<div class="section" id="istio-configuration">
<h2>Istio configuration<a class="headerlink" href="#istio-configuration" title="Permalink to this headline">¶</a></h2>
<p>Your kubernetes environment will need to have the Istio Service Mesh deployed and have a <code class="docutils literal notranslate"><span class="pre">gateway</span></code> resource deployed as part of the Canvas. The Operator creates Istio <code class="docutils literal notranslate"><span class="pre">VirtualService</span></code> resources. These create traffic policies in Istio to route traffic (based on the API Path) to the correct micro-services. For this controller, we have named the <code class="docutils literal notranslate"><span class="pre">gateway</span></code> resource <code class="docutils literal notranslate"><span class="pre">component-gateway</span></code>.</p>
<div class="section" id="listening-for-api-status-updates">
<h3>Listening for API status updates<a class="headerlink" href="#listening-for-api-status-updates" title="Permalink to this headline">¶</a></h3>
<p>The sequence diagram above includes <em>Listen for updates to the external URL/IP Address</em>. The API resource is expecting two updates:</p>
<ul class="simple">
<li><p>It expects an update with the external URL or IP Address where the API is exposed.</p></li>
<li><p>It expects an update with the readiness status of the API (i.e. is the API ready to receive traffic).</p></li>
</ul>
<p>For the Istio Virtual service, the URL/IP address is determined form the Istio <code class="docutils literal notranslate"><span class="pre">gateway</span></code> resource. The API Operator includes lookup to get the external URL/IP address from the status of the <code class="docutils literal notranslate"><span class="pre">gateway</span></code> resource. If you used a different API Gatway or Service Mesh combination, you may need to lookup the external address using different resources or using APIs on the API Gatway itself.</p>
<p>For the readiness status of the API, the API Operator listens for update to <code class="docutils literal notranslate"><span class="pre">EndPointSlice</span></code> resources. The <code class="docutils literal notranslate"><span class="pre">EndPointSlice</span></code> resource is created by kubernetes when a service is deployed. The <code class="docutils literal notranslate"><span class="pre">EndPointSlice</span></code> resource tracks the readiness of all the pods that are part of the service. The API Operator listens for updates to the <code class="docutils literal notranslate"><span class="pre">EndPointSlice</span></code> resource and updates the status of the API resource accordingly.</p>
</div>
</div>
<div class="section" id="optional-configuration-for-datadog-using-pod-annotations">
<h2>optional configuration for DataDog using pod annotations<a class="headerlink" href="#optional-configuration-for-datadog-using-pod-annotations" title="Permalink to this headline">¶</a></h2>
<p>The API operator for Istio can be configured to use DataDog to monitor the API. The API Operator can take an environment variable <code class="docutils literal notranslate"><span class="pre">OPENMETRICS_IMPLEMENTATION</span></code> which defaults to <code class="docutils literal notranslate"><span class="pre">ServiceMonitor</span></code> (for prometheus operator). If you set <code class="docutils literal notranslate"><span class="pre">OPENMETRICS_IMPLEMENTATION</span></code> to <code class="docutils literal notranslate"><span class="pre">DataDogAnnotations</span></code>, the API Operator will add the DataDog annotations to the pod running the metrics API (which DataDog uses to scrape custom metrics) instead of creating the <code class="docutils literal notranslate"><span class="pre">ServiceMonitor</span></code> resource.</p>
<div class="section" id="implementation">
<h3>Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h3>
<p>This operator is written in Python, using the KOPF (https://kopf.readthedocs.io/) framework to listen for API resources being deployed in the ODA Canvas.</p>
</div>
<div class="section" id="testing-kopf-module">
<h3>Testing KOPF module<a class="headerlink" href="#testing-kopf-module" title="Permalink to this headline">¶</a></h3>
<p>Run: <code class="docutils literal notranslate"><span class="pre">kopf</span> <span class="pre">run</span> <span class="pre">--namespace=components</span> <span class="pre">--standalone</span> <span class="pre">.\apiOperatorIstio.py</span></code></p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="apiOperatorIstio.html" class="btn btn-neutral float-right" title="apiOperatorIstio module" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="modules.html" class="btn btn-neutral float-left" title="API Operator: Istio" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2023, TM Forum ODA-Component Accelerator project.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>