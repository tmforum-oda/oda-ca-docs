<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>API Operator for Istio &mdash; ODA-Component Accelerator v1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/custom.css?v=6567dac9" />

  
  <!--[if lt IE 9]>
    <script src="../../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../../../_static/documentation_options.js?v=5cb08e4e"></script>
        <script src="../../../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />
    <link rel="next" title="apiOperatorIstio module" href="apiOperatorIstio.html" />
    <link rel="prev" title="API Operator: Istio" href="modules.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            ODA-Component Accelerator
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">About the project:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../docs/Playbook.html">Introduction to the ODA Component Accelerator Project (ODA-CA)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../docs/Getting_started.html">Getting started checklist for new members of ODA-CA</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../docs/Observability-Tutorial/README.html">Tutorial to deploy and observe a running component</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../docs/ODAComponentTutorial/README.html">Tutorial to build ODA-Component from Open-API Reference Implementation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Component:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../docs/ODAComponentDesignGuidelines.html">Design Guidelines to create a new ODA Component</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Canvas:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../README.html">Open Digital Architecture Canvas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation/README.html">ODA Canvas installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Canvas Design:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../Canvas-design.html">ODA Canvas Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../Design-Epics.html">Design Epics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../usecase-library/README.html">ODA Canvas - use-case library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../Usecases.html">Usecase List</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../usecase-library/use-case-naming-conventions.html">Use case naming conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../README.html">ODA Canvas source code</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Open Digital Architecture - Operators</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../README.html">ODA Canvas Operators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../component-management/modules.html">Component Operator</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="modules.html">API Operator: Istio</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">API Operator for Istio</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#istio-configuration">Istio configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#optional-configuration-for-datadog-or-different-prometheus-implementations">optional configuration for DataDog or different Prometheus implementations</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="modules.html#python-modules">Python modules</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../kong/modules.html">API Operator: Kong</a></li>
<li class="toctree-l2"><a class="reference internal" href="../apache-apisix/modules.html">API Operator: Apisix</a></li>
<li class="toctree-l2"><a class="reference internal" href="../apigee/modules.html">API Operator: Apigee API Gateway</a></li>
<li class="toctree-l2"><a class="reference internal" href="../azure-apim/modules.html">API Operator: Azure-Apim</a></li>
<li class="toctree-l2"><a class="reference internal" href="../whalecloud-apim/modules.html">API Operator: Whalecloud Apim</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../identity-config/keycloak/modules.html">Security Operator</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../webhooks-and-utilities.html">Webuooks and Utilities</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Feature Tests:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../feature-definition-and-test-kit/README.html">ODA Canvas Features and Test Kit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../feature-definition-and-test-kit/README.html#list-of-bdd-features">List of BDD Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../feature-definition-and-test-kit/Executing-tests.html">Installing and executing the BDD tests</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributions and Troubleshooting:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../docs/ContributionsGuide.html">Contribution guidance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../docs/TroubleshootingGuide/index.html">Troubleshooting Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../docs/developer/work-with-dockerimages.html">Developer How-Tos: Work with Dockerimages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../docs/developer/work-with-dockerimages.html#summary">Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../docs/developer/work-with-dockerimages.html#how-to-add-a-new-dockerimage">How-To add a new Dockerimage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../docs/developer/work-with-dockerimages.html#how-to-define-unit-tests">How-To define unit tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../devcontainer.html">ODA Canvas Development Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Installing%20KOPF%20development%20environment.html">Installing KOPF (tested in GKE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../docs/DocumentationProcess.html">Documentation Process</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">ODA-Component Accelerator</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Open Digital Architecture - Operators</a></li>
          <li class="breadcrumb-item"><a href="modules.html">API Operator: Istio</a></li>
      <li class="breadcrumb-item active">API Operator for Istio</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../../_sources/canvas/source/operators/api-management/istio/README.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="api-operator-for-istio">
<h1>API Operator for Istio<a class="headerlink" href="#api-operator-for-istio" title="Link to this heading"></a></h1>
<p>This <strong>API operator</strong> manages a Canvas environment that exposes APIs using Istio Service Mesh (without any API Gateway). It is a reference implementation of an API Operator. You are free to reuse, extend or replace with your own API operator.</p>
<p>It also configures custom resources and annotations to support Open Metrics observability data (using <strong>Prometheus</strong> or a managed service that can work with the Open Metrics standard)</p>
<p>Both <strong>Istio</strong> and <strong>Prometheus</strong> can be configured using Kubernetes Custom Resource Definitions (CRD). The API Operator uses the Kubernetes API to listen for changes to CRDs and then configures Istio and Prometheus accordingly.</p>
<p>Istio uses <code class="docutils literal notranslate"><span class="pre">VirtualService</span></code> resources (<a class="reference external" href="https://istio.io/latest/docs/reference/config/networking/virtual-service/">https://istio.io/latest/docs/reference/config/networking/virtual-service/</a>) to configure traffic routing in the Istio control plane.</p>
<p>Prometheus uses <code class="docutils literal notranslate"><span class="pre">ServiceMonitor</span></code> resources (<a class="reference external" href="https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/user-guides/getting-started.md">https://github.com/prometheus-operator/prometheus-operator/blob/main/Documentation/user-guides/getting-started.md</a>) to configure the Prometheus monitoring system.</p>
<p>This makes the logic required to create an API Operator relatively simple. The API Operator listens for new/updated/deleted <code class="docutils literal notranslate"><span class="pre">oda.tmforum.org/ExposedAPI</span></code> resources and then creates/updates/deletes the corresponding Virtual Service and Service Monitor resources. The API Operator also listens for status updates from Istio and Prometheus and updates the status of the <code class="docutils literal notranslate"><span class="pre">oda.tmforum.org/ExposedAPI</span></code> resource accordingly.</p>
<p><img alt="API Operator" src="http://www.plantuml.com/plantuml/proxy?cache=no&amp;src=https://raw.githubusercontent.com/tmforum-oda/oda-ca/master/controllers/apiOperatorIstio/sequenceDiagrams/apiOperatorIstio.puml" />
<a class="reference download internal" download="" href="../../../../../_downloads/12fd8a1a6385d28ddaa7ec365ea00dbc/apiOperatorIstio.puml"><span class="xref download myst">plantUML code</span></a></p>
<section id="istio-configuration">
<h2>Istio configuration<a class="headerlink" href="#istio-configuration" title="Link to this heading"></a></h2>
<p>Your kubernetes environment will need to have the Istio Service Mesh deployed and have a <code class="docutils literal notranslate"><span class="pre">gateway</span></code> resource deployed as part of the Canvas. The Operator creates Istio <code class="docutils literal notranslate"><span class="pre">VirtualService</span></code> resources. These create traffic policies in Istio to route traffic (based on the API Path) to the correct micro-services. For this controller, we have named the <code class="docutils literal notranslate"><span class="pre">gateway</span></code> resource <code class="docutils literal notranslate"><span class="pre">component-gateway</span></code>.</p>
<section id="listening-for-api-status-updates">
<h3>Listening for API status updates<a class="headerlink" href="#listening-for-api-status-updates" title="Link to this heading"></a></h3>
<p>The sequence diagram above includes <em>Listen for updates to the external URL/IP Address</em>. The API resource is expecting two updates:</p>
<ul class="simple">
<li><p>It expects an update with the external URL or IP Address where the API is exposed.</p></li>
<li><p>It expects an update with the readiness status of the API (i.e. is the API ready to receive traffic).</p></li>
</ul>
<p>For the Istio Virtual service, the URL/IP address is determined form the Istio <code class="docutils literal notranslate"><span class="pre">gateway</span></code> resource. The API Operator includes lookup to get the external URL/IP address from the status of the <code class="docutils literal notranslate"><span class="pre">gateway</span></code> resource. If you used a different API Gatway or Service Mesh combination, you may need to lookup the external address using different resources or using APIs on the API Gatway itself.</p>
<p>For the readiness status of the API, the API Operator listens for update to <code class="docutils literal notranslate"><span class="pre">EndPointSlice</span></code> resources. The <code class="docutils literal notranslate"><span class="pre">EndPointSlice</span></code> resource is created by kubernetes when a service is deployed. The <code class="docutils literal notranslate"><span class="pre">EndPointSlice</span></code> resource tracks the readiness of all the pods that are part of the service. The API Operator listens for updates to the <code class="docutils literal notranslate"><span class="pre">EndPointSlice</span></code> resource and updates the status of the API resource accordingly.</p>
</section>
</section>
<section id="optional-configuration-for-datadog-or-different-prometheus-implementations">
<h2>optional configuration for DataDog or different Prometheus implementations<a class="headerlink" href="#optional-configuration-for-datadog-or-different-prometheus-implementations" title="Link to this heading"></a></h2>
<p>The API operator for Istio can be configured to use annotations instead of Service Monitor resources. The API Operator can take an environment variable <code class="docutils literal notranslate"><span class="pre">OPENMETRICS_IMPLEMENTATION</span></code> which can be set to:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ServiceMonitor</span></code> (default) Uses Service Monitor custom resources to configure Prometheus (using prometheus operator).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DataDogAnnotations</span></code> Uses Pod annotations in format used by DataDog (which DataDog uses to scrape custom metrics) instead of creating the <code class="docutils literal notranslate"><span class="pre">ServiceMonitor</span></code> resource.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PrometheusAnnotation</span></code> Uses Pod annotations in format used by Prometheus (without Prometheus operator) instead of creating the <code class="docutils literal notranslate"><span class="pre">ServiceMonitor</span></code> resource. This is used by some managed Prometheus services (like Azure managed Prometheus <a class="reference external" href="https://learn.microsoft.com/en-us/azure/azure-monitor/essentials/prometheus-metrics-overview">https://learn.microsoft.com/en-us/azure/azure-monitor/essentials/prometheus-metrics-overview</a>).</p></li>
</ul>
<section id="implementation">
<h3>Implementation<a class="headerlink" href="#implementation" title="Link to this heading"></a></h3>
<p>This operator is written in Python, using the KOPF (<a class="reference external" href="https://kopf.readthedocs.io/">https://kopf.readthedocs.io/</a>) framework to listen for API resources being deployed in the ODA Canvas.</p>
<p><strong>Interactive development and Testing of operator using KOPF</strong></p>
<p>The production operator will execute inside a Kubernetes Pod. For development and testing, it is possible to run the operator on the command-line (or inside a debugger). Kopf includes a <code class="docutils literal notranslate"><span class="pre">--standalone</span></code> attribute to allow the operator to execute in a standalone mode. This means that the operator will run independently, without relying on any external controllers or frameworks. It is particularly useful for development and debugging purposes, as it allows you to run and test your operator locally on your machine.</p>
<p>Run locally in command-line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kopf</span> <span class="n">run</span> <span class="o">--</span><span class="n">namespace</span><span class="o">=</span><span class="n">components</span> <span class="o">--</span><span class="n">standalone</span> <span class="o">.</span>\<span class="n">apiOperatorIstio</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>This mode will use the kubeconfig file (typically located at <code class="docutils literal notranslate"><span class="pre">$HOME/.kube/config</span></code>) to as long as <code class="docutils literal notranslate"><span class="pre">kubectl</span></code> is correctly configured for your cluster, the operator should work.</p>
<p>You need to ensure you turn-off the operator execusing in Kubernetes (for example, by setting the replicas to 0 in the operator Deployment).</p>
<p>The command above will execute just the ExposedAPI operator. You will also need to execute the other operators relevant for your Canvas implementation - these can be executed in separate terminal command-lines.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="modules.html" class="btn btn-neutral float-left" title="API Operator: Istio" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="apiOperatorIstio.html" class="btn btn-neutral float-right" title="apiOperatorIstio module" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, TM Forum ODA-Component Accelerator project.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>