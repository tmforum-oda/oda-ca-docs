<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tutorial to build ODA-Component from Open-API Reference Implementation &mdash; ODA-Component Accelerator v1beta3 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css?v=6567dac9" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=546c8a9f"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Design Guidelines to create a new ODA Component" href="../ODAComponentDesignGuidelines.html" />
    <link rel="prev" title="Tutorial to deploy and observe a running component" href="../Observability-Tutorial/README.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            ODA-Component Accelerator
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">About the project:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Playbook.html">Introduction to the ODA Component Accelerator Project (ODA-CA)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Getting_started.html">Getting started checklist for new members of ODA-CA</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Observability-Tutorial/README.html">Tutorial to deploy and observe a running component</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tutorial to build ODA-Component from Open-API Reference Implementation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#step-1-download-reference-implementation">Step 1. Download Reference Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#step-2-optionally-test-locally-with-local-mongodb">Step 2. (optionally) test locally with local MongoDb.</a></li>
<li class="toctree-l2"><a class="reference internal" href="#step-3-configure-for-use-within-kubernetes">Step 3. Configure for use within Kubernetes.</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configure-mongodb-connection-url-to-use-within-kubernetes">3.1 Configure MongoDb connection url to use within Kubernetes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#use-environment-variables-to-allow-api-path-to-be-configured-externally">3.2 Use environment variables to allow API path to be configured externally</a></li>
<li class="toctree-l2"><a class="reference internal" href="#add-home-resource-at-root-of-the-api-and-also-move-where-the-docs-and-api-docs-are-hosted">3.3 Add home resource at root of the API, and also move where the docs and api-docs are hosted</a></li>
<li class="toctree-l2"><a class="reference internal" href="#step-4-package-the-nodejs-implementation-into-a-docker-image">Step 4. Package the nodejs implementation into a docker image</a></li>
<li class="toctree-l2"><a class="reference internal" href="#step-5-create-partyrole-implementation">Step 5. Create PartyRole Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#step-6-create-partyrole-initialisation-implementation">Step 6. Create PartyRole Initialisation Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#step-6-1-package-the-nodejs-implementation-into-a-docker-image-following-step-4-above">Step 6.1 Package the nodejs implementation into a docker image following step 4 above.</a></li>
<li class="toctree-l2"><a class="reference internal" href="#step-7-create-component-envelope">Step 7. Create Component Envelope</a></li>
<li class="toctree-l2"><a class="reference internal" href="#step-6-test-component-envelope-using-component-ctk">Step 6. Test component envelope using component CTK</a></li>
<li class="toctree-l2"><a class="reference internal" href="#step-8-deploy-the-component-envelope-into-open-digital-lab-canvas">Step 8. Deploy the component envelope into Open Digital Lab canvas</a></li>
<li class="toctree-l2"><a class="reference internal" href="#directory-structure">Directory Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="#issues-resolution">ISSUES &amp; resolution</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Component:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../ODAComponentDesignGuidelines.html">Design Guidelines to create a new ODA Component</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ctk/README.html">ODA Component - CTK</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Canvas:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../canvas/README.html">Open Digital Architecture Canvas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../canvas/installation/README.html">ODA Canvas installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Canvas Design:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../canvas/Canvas-design.html">ODA Canvas Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../canvas/Design-Epics.html">Design Epics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../canvas/usecase-library/README.html">ODA Canvas - use-case library</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../canvas/Usecases.html">Usecase List</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../canvas/usecase-library/use-case-naming-conventions.html">Use case naming conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../canvas/source/README.html">ODA Canvas source code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../canvas/source/operators/index.html">Open Digital Architecture - Controllers/Operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../canvas/source/webhooks-and-utilities.html">Webuooks and Utilities</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Feature Tests:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../canvas/feature-definition-and-test-kit/README.html">ODA Canvas Features and Test Kit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../canvas/feature-definition-and-test-kit/README.html#list-of-bdd-features">List of BDD Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../canvas/feature-definition-and-test-kit/Executing-tests.html">Installing and executing the BDD tests</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributions and Troubleshooting:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../ContributionsGuide.html">Contribution guidance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../TroubleshootingGuide/index.html">Troubleshooting Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer/work-with-dockerimages.html">Developer How-Tos: Work with Dockerimages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer/work-with-dockerimages.html#summary">Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer/work-with-dockerimages.html#how-to-add-a-new-dockerimage">How-To add a new Dockerimage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../canvas/devcontainer.html">ODA Canvas Development Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../canvas/source/operators/Installing%20KOPF%20development%20environment.html">Installing KOPF (tested in GKE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../DocumentationProcess.html">Documentation Process</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ODA-Component Accelerator</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Tutorial to build ODA-Component from Open-API Reference Implementation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/docs/ODAComponentTutorial/README.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="tutorial-to-build-oda-component-from-open-api-reference-implementation">
<h1>Tutorial to build ODA-Component from Open-API Reference Implementation<a class="headerlink" href="#tutorial-to-build-oda-component-from-open-api-reference-implementation" title="Link to this heading"></a></h1>
<p>This tutorial shows the complete process to package, test and deploy an ODA-Component, using the nodejs reference implementation of the TMF637 Product Inventory Management API as the source code. You should be able to follow the process below using an existing software application as source. The process should work for simple applications - it is intended as a tutorial to get you started. For more complex applications you may have to decompose to multiple containers/micro-services and even multiple ODA-Components.</p>
<blockquote>
<div><p><strong>Note:</strong> This tutorial has been updated for v1beta3 version of the ODA component speficiation
and should be deployed unto an ODA Canvas environment that supports this version of the specification.</p>
</div></blockquote>
<!-- There is a video of this tutorial at: [ODA Component Tutorial Video walkthrough](https://youtu.be/wZJ8d5uQ7_8) --->
<p>For an introdution to the Open-Digital Architecture component model, take a look at the recording from the Digital Transformation World Series conference:</p>
<p><img alt="https://www.youtube.com/watch?v=e_m-nnKvWIs" src="../../_images/DTW-Video.png" /></p>
<p><a class="reference external" href="https://www.youtube.com/watch?v=e_m-nnKvWIs">DTW World Series Masterclass:Leveraging ODA and Open APIs to achieve digital transformation</a></p>
<section id="step-1-download-reference-implementation">
<h2>Step 1. Download Reference Implementation<a class="headerlink" href="#step-1-download-reference-implementation" title="Link to this heading"></a></h2>
<p>We are using one of the Reference implementations of the Open-APIs as a starting point. Go to the open-API Table at <a class="reference external" href="https://projects.tmforum.org/wiki/display/API/Open+API+Table">https://projects.tmforum.org/wiki/display/API/Open+API+Table</a> and download one of the reference implmentation <code class="docutils literal notranslate"><span class="pre">.zip</span></code> files (we are using the Product Inventory Management API version 4, but you can choose any).</p>
<p><img alt="" src="../../_images/Open-API-Table.png" /></p>
<p>The reference implementation provides a Nodejs API server implementation that requires a MongoDb backend. It provides a nice swagger-ui on top of a Open-API implementation stub. The reference implementation is set-up to run in IBM Cloud (bluemix). To enable it to run locally or in a docker container, we edit the /api/swagger.yaml file to remove the <code class="docutils literal notranslate"><span class="pre">host:</span></code> field (it will default to looking in the current host), and change the <code class="docutils literal notranslate"><span class="pre">schemes:</span></code> from <code class="docutils literal notranslate"><span class="pre">https</span></code> to <code class="docutils literal notranslate"><span class="pre">http</span></code>.</p>
</section>
<section id="step-2-optionally-test-locally-with-local-mongodb">
<h2>Step 2. (optionally) test locally with local MongoDb.<a class="headerlink" href="#step-2-optionally-test-locally-with-local-mongodb" title="Link to this heading"></a></h2>
<p>In the <code class="docutils literal notranslate"><span class="pre">utils/mongoUtils.js</span></code> file, you will need to replace the connectHelper with a helper function that uses local connection string:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="cm">/* connection helper for running MongoDb from url */</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">connectHelper</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">credentials_uri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;mongodb://localhost:27017/tmf&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">useNewUrlParser</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span>
<span class="w">  </span><span class="p">};</span>
<span class="w">  </span><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">credentials_uri</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">db</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">mongodb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">      </span><span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="kc">null</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">mongodb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="s2">&quot;tmf&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="nx">mongodb</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can then test the API by using <code class="docutils literal notranslate"><span class="pre">npm</span> <span class="pre">install</span></code> and <code class="docutils literal notranslate"><span class="pre">npm</span> <span class="pre">start</span></code>. You should be able to view the API in a browser by browsing to <a class="reference external" href="http://localhost:8080/docs">http://localhost:8080/docs</a>.</p>
</section>
<section id="step-3-configure-for-use-within-kubernetes">
<h2>Step 3. Configure for use within Kubernetes.<a class="headerlink" href="#step-3-configure-for-use-within-kubernetes" title="Link to this heading"></a></h2>
<p>When we depoy this nodejs code for use within Kubernetes, it will connect to MongoDb using a url which is provided by a Kubernetes service. We also use environment variable to allow Kubernetes to, for example, determine the path where the API is exposed.</p>
</section>
<section id="configure-mongodb-connection-url-to-use-within-kubernetes">
<h2>3.1 Configure MongoDb connection url to use within Kubernetes<a class="headerlink" href="#configure-mongodb-connection-url-to-use-within-kubernetes" title="Link to this heading"></a></h2>
<p>In the <code class="docutils literal notranslate"><span class="pre">utils/mongoUtils.js</span></code> file, you will need to update the local connection string to a url that wil work within Kubernetes (this will match the kubernetes service name for mongoDb). Note we include a release name passed as an environment variable (as we could potentially deploy multiple instances of a component in the same canvas).</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="cm">/* connection helper for running MongoDb from url */</span>
<span class="kd">function</span><span class="w"> </span><span class="nx">connectHelper</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">releaseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">RELEASE_NAME</span><span class="p">;</span><span class="w"> </span><span class="c1">// Release name from Helm deployment</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">credentials_uri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;mongodb://&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">releaseName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;-mongodb:27017/tmf&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">useNewUrlParser</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span>
<span class="w">  </span><span class="p">};</span>
<span class="w">  </span><span class="nx">MongoClient</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">credentials_uri</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">db</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">mongodb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">      </span><span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="kc">null</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">mongodb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">db</span><span class="p">(</span><span class="s2">&quot;tmf&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="nx">mongodb</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="use-environment-variables-to-allow-api-path-to-be-configured-externally">
<h2>3.2 Use environment variables to allow API path to be configured externally<a class="headerlink" href="#use-environment-variables-to-allow-api-path-to-be-configured-externally" title="Link to this heading"></a></h2>
<p>By default the nodejs code will serve the API at the path in the swagger file, which for our example is <code class="docutils literal notranslate"><span class="pre">/tmf-api/tmf-api/productInventory/v4/</span></code>. We want to potentially deploy multiple component instances in the same environment, and so we add a configurable <code class="docutils literal notranslate"><span class="pre">COMPONENT_NAME</span></code> to the start of the URL. We need to do this in the <code class="docutils literal notranslate"><span class="pre">swaggerDoc</span></code> as well as in the <code class="docutils literal notranslate"><span class="pre">swagger-ui-dist/index.html</span></code> that provides the swagger user interface.</p>
<p>Edit the <code class="docutils literal notranslate"><span class="pre">./index.js</span></code> file in the implementation root directory.</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">swaggerDoc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">swaggerUtils</span><span class="p">.</span><span class="nx">getSwaggerDoc</span><span class="p">();</span>

<span class="c1">// Get Component instance name from Environment variable and put it at start of API path</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">componentName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">COMPONENT_NAME</span><span class="p">;</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">componentName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">componentName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;productinventory&#39;</span>
<span class="p">}</span>
<span class="c1">// Remove leading and trailing slashes from componentName</span>
<span class="nx">componentName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">componentName</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\/+|\/+$/g</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>

<span class="c1">// end</span>

<span class="c1">// Remove leading slashes from basePath and ensure it does not end with a trailing slash</span>
<span class="nx">swaggerDoc</span><span class="p">.</span><span class="nx">basePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">swaggerDoc</span><span class="p">.</span><span class="nx">basePath</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\/+|\/+$/g</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>

<span class="c1">// add component name to swaggerDoc</span>
<span class="nx">swaggerDoc</span><span class="p">.</span><span class="nx">basePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">componentName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="nx">swaggerDoc</span><span class="p">.</span><span class="nx">basePath</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">swaggerDoc</span><span class="p">.</span><span class="nx">basePath</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">);</span>

<span class="c1">// add component name to url in swagger_ui - i.e. swagger-ui-dist/index.html</span>
<span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;./node_modules/swagger-ui-dist/index.html&#39;</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;utf8&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;error reading the file&#39;</span><span class="o">+</span><span class="w"> </span><span class="nx">err</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// Ensure exactly one leading slash in basePath before concatenating with &#39;/api-docs&#39;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">basePathWithSingleSlash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">swaggerDoc</span><span class="p">.</span><span class="nx">basePath</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/+/g</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/api-docs/g</span><span class="p">,</span><span class="w"> </span><span class="nx">basePathWithSingleSlash</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;/api-docs&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;result of replacing &#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;updating &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;./node_modules/swagger-ui-dist/index.html&#39;</span><span class="p">));</span>
<span class="w">  </span><span class="nx">fs</span><span class="p">.</span><span class="nx">writeFile</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;./node_modules/swagger-ui-dist/index.html&#39;</span><span class="p">),</span><span class="w"> </span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;utf8&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">});</span>

<span class="c1">//end</span>
</pre></div>
</div>
</section>
<section id="add-home-resource-at-root-of-the-api-and-also-move-where-the-docs-and-api-docs-are-hosted">
<h2>3.3 Add home resource at root of the API, and also move where the docs and api-docs are hosted<a class="headerlink" href="#add-home-resource-at-root-of-the-api-and-also-move-where-the-docs-and-api-docs-are-hosted" title="Link to this heading"></a></h2>
<p>By default, the swagger tools expose a resource at all the paths in the API (defined in the swagger.yaml file); They don’t offer any response at the root of the API. This can make it harder for a developer to discover the API paths. In addition, a Kubernetes ingress will by default test the root of the API (as a liveness test). If it receives no response, it will assume the microservice is dead and will not route any traffic to it. A simple solution is to create a home resource that provides a set of links to the other API endpoints. The TM Forum Open-API design standards (TMF630) provides a good definition of this resource which is called the <code class="docutils literal notranslate"><span class="pre">home</span></code> or <code class="docutils literal notranslate"><span class="pre">entrypoint</span></code> resource.</p>
<p>First, we’ve created a simple module in <code class="docutils literal notranslate"><span class="pre">utils/entrypoint.js</span></code> to build this entrypoint resource at run-time from the swagger.yaml. Operating at run-time also provides the ability to send a contextual response (that might vary depending on the role of the user, for example).</p>
<p>Next, we integrated this module by adding <code class="docutils literal notranslate"><span class="pre">app.use(swaggerDoc.basePath,</span> <span class="pre">entrypointUtils.entrypoint);</span></code> as the last hook before starting the server.</p>
<p>Finally, we change the path where the ‘api-docs’ and ‘docs’ are exposed. By default they are served at <code class="docutils literal notranslate"><span class="pre">/api-docs</span></code> and <code class="docutils literal notranslate"><span class="pre">/docs</span></code>. Again, we want to avoid conflicts if we have multiple components running in the same environment. We solve this by moving them to the full path of the API, so in our example, they would be at <code class="docutils literal notranslate"><span class="pre">/tmf-api/tmf-api/productInventory/v4/</span></code></p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">// Serve the Swagger documents and Swagger UI</span>
<span class="w">  </span><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">middleware</span><span class="p">.</span><span class="nx">swaggerUi</span><span class="p">({</span><span class="w">   </span><span class="nx">apiDocs</span><span class="o">:</span><span class="w"> </span><span class="nx">swaggerDoc</span><span class="p">.</span><span class="nx">basePath</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;api-docs&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">swaggerUi</span><span class="o">:</span><span class="w"> </span><span class="nx">swaggerDoc</span><span class="p">.</span><span class="nx">basePath</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;docs&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">swaggerUiDir</span><span class="o">:</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;node_modules&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;swagger-ui-dist&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">}));</span>

<span class="w">  </span><span class="c1">// create an entrypoint</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">entrypointUtils</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./utils/entrypoint&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;app.use entrypoint&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">swaggerDoc</span><span class="p">.</span><span class="nx">basePath</span><span class="p">,</span><span class="w"> </span><span class="nx">entrypointUtils</span><span class="p">.</span><span class="nx">entrypoint</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Start the server</span>
<span class="w">  </span><span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">app</span><span class="p">).</span><span class="nx">listen</span><span class="p">(</span><span class="nx">serverPort</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Your server is listening on port %d (http://localhost:%d)&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">serverPort</span><span class="p">,</span><span class="w"> </span><span class="nx">serverPort</span><span class="p">);</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Swagger-ui is available on http://localhost:&#39;</span><span class="o">+</span><span class="w"> </span><span class="nx">serverPort</span><span class="w">  </span><span class="o">+</span><span class="w"> </span><span class="nx">swaggerDoc</span><span class="p">.</span><span class="nx">basePath</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;docs&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">serverPort</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>
</pre></div>
</div>
</section>
<section id="step-4-package-the-nodejs-implementation-into-a-docker-image">
<h2>Step 4. Package the nodejs implementation into a docker image<a class="headerlink" href="#step-4-package-the-nodejs-implementation-into-a-docker-image" title="Link to this heading"></a></h2>
<p>Create a dockerfile in the product inventory implementation directory with the instructions to build our image. We are starting with the official <a class="reference external" href="https://hub.docker.com/_/node">node</a> docker image.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>FROM node:12
</pre></div>
</div>
<p>Define the working directory of a Docker container</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>WORKDIR /usr/app
</pre></div>
</div>
<p>This image comes with Node.js and NPM already installed so the next thing we need to do is to install the app dependencies.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>COPY package*.json ./
RUN npm install
</pre></div>
</div>
<p>Then we copy the source code.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>COPY . .
</pre></div>
</div>
<p>The app binds to port 8080 so we’ll use the EXPOSE instruction to have it mapped by the docker daemon:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>EXPOSE 8080
</pre></div>
</div>
<p>Finally we define the command that will run the app.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>CMD [&quot;node&quot;, &quot;index.js&quot;]
</pre></div>
</div>
<p>The complete dockerfile should look like:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>FROM node:12
WORKDIR /usr/app
COPY package*.json ./
RUN npm install
COPY . .
EXPOSE 8080
CMD [&quot;node&quot;, &quot;index.js&quot;]
</pre></div>
</div>
<p>Before we build this dockerfile, we create a <code class="docutils literal notranslate"><span class="pre">.dockerignore</span></code> file (so the at node_modules packages are not copied into the docker image - this would make the image very large. The <code class="docutils literal notranslate"><span class="pre">RUN</span> <span class="pre">npm</span> <span class="pre">install</span></code> command inside the dockerfile will install these on demand).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">node_modules</span>
<span class="n">npm</span><span class="o">-</span><span class="n">debug</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
<p>To build the docker image, we use the command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">build</span> <span class="o">.</span> <span class="o">-</span><span class="n">t</span> <span class="n">dominico</span><span class="o">/</span><span class="n">productinventoryapi</span><span class="p">:</span><span class="mf">0.2</span> <span class="o">-</span><span class="n">t</span> <span class="n">dominico</span><span class="o">/</span><span class="n">productinventoryapi</span><span class="p">:</span><span class="n">latest</span>
</pre></div>
</div>
<p>Note: we use the -t to tag the image. We give the image two tags, one with a version number and the other with a <code class="docutils literal notranslate"><span class="pre">latest</span></code> tag that will overwrite any previously uploaded images.</p>
<p>To check that the images are in the local repository, we use this command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">docker</span> <span class="n">images</span>

<span class="o">--</span><span class="n">Result</span><span class="o">--</span>
<span class="n">REPOSITORY</span>                     <span class="n">TAG</span>       <span class="n">IMAGE</span> <span class="n">ID</span>       <span class="n">CREATED</span>             <span class="n">SIZE</span>
<span class="n">dominico</span><span class="o">/</span><span class="n">productinventoryapi</span>   <span class="mf">0.2</span>       <span class="mi">6</span><span class="n">f2819946f76</span>   <span class="n">About</span> <span class="n">an</span> <span class="n">hour</span> <span class="n">ago</span>   <span class="mi">910</span><span class="n">MB</span>
<span class="n">dominico</span><span class="o">/</span><span class="n">productinventoryapi</span>   <span class="n">latest</span>    <span class="mi">6</span><span class="n">f2819946f76</span>   <span class="n">About</span> <span class="n">an</span> <span class="n">hour</span> <span class="n">ago</span>   <span class="mi">910</span><span class="n">MB</span>

</pre></div>
</div>
<p>Finally we upload the docker image to a Docker repository. I’m using the default <a class="reference external" href="https://hub.docker.com">DockerHub</a> with an account <code class="docutils literal notranslate"><span class="pre">dominico</span></code> that I have created previously. If this is the first time accessing the docker repository you will need to login first with the <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">login</span></code> command.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>docker<span class="w"> </span>push<span class="w">  </span>dominico/productinventoryapi<span class="w"> </span>--all-tags
</pre></div>
</div>
</section>
<section id="step-5-create-partyrole-implementation">
<h2>Step 5. Create PartyRole Implementation<a class="headerlink" href="#step-5-create-partyrole-implementation" title="Link to this heading"></a></h2>
<p>Product Inventory component requires a Party Role Microservice that implements the TMF669 Party Role Management API (based on the NodeJs reference implementation). Party Role provides security supporting function and canvas service to the Product Inventory Component.</p>
<p>Follow the previous steps 1-4 to create the Party Role implementation.</p>
</section>
<section id="step-6-create-partyrole-initialisation-implementation">
<h2>Step 6. Create PartyRole Initialisation Implementation<a class="headerlink" href="#step-6-create-partyrole-initialisation-implementation" title="Link to this heading"></a></h2>
<p>Next we create a party role initialisation node js service (<code class="docutils literal notranslate"><span class="pre">initialization.js</span></code>) which  initialises party roles in the mongo db database.
Excerpts from <code class="docutils literal notranslate"><span class="pre">&lt;roleinti-implementation-directory&gt;/initialization.js</span></code> as below:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">axios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;axios&#39;</span><span class="p">);</span>
<span class="c1">//create a Admin Party role</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">initialPartyRole</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Admin&quot;</span>
<span class="p">}</span>

<span class="c1">// Get Component instance name from Environment variable and put it at start of API path</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">releaseName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">RELEASE_NAME</span><span class="p">;</span><span class="w"> </span>
<span class="kd">var</span><span class="w"> </span><span class="nx">componentName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">COMPONENT_NAME</span><span class="p">;</span><span class="w"> </span>

<span class="kd">const</span><span class="w"> </span><span class="nx">createPartyRole</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">complete</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>

<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">complete</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">delay</span><span class="p">(</span><span class="mf">5000</span><span class="p">);</span><span class="w">  </span><span class="c1">// retry every 5 seconds</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;http://&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">releaseName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;-partyroleapi:8080/&#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">componentName</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;/tmf-api/partyRoleManagement/v4/partyRole&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;POSTing partyRole to: &#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">url</span><span class="p">);</span>
<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">axios</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span>
<span class="w">          </span><span class="nx">url</span><span class="p">,</span><span class="w"> </span>
<span class="w">          </span><span class="nx">initialPartyRole</span><span class="p">,</span>
<span class="w">          </span><span class="p">{</span><span class="nx">timeout</span><span class="o">:</span><span class="w"> </span><span class="mf">10000</span><span class="p">});</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Status: </span><span class="si">${</span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Body: &#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
<span class="w">        </span><span class="nx">complete</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">....</span><span class="w"> </span>

<span class="w">        </span><span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mf">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Initialization failed - retrying in 5 seconds&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>
<span class="p">...</span>
</pre></div>
</div>
</section>
<section id="step-6-1-package-the-nodejs-implementation-into-a-docker-image-following-step-4-above">
<h2>Step 6.1 Package the nodejs implementation into a docker image following step 4 above.<a class="headerlink" href="#step-6-1-package-the-nodejs-implementation-into-a-docker-image-following-step-4-above" title="Link to this heading"></a></h2>
<p>The role initialisation dockerfile file:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>FROM node:12
WORKDIR /src
COPY package*.json ./
RUN npm install
COPY . .
CMD [&quot;node&quot;, &quot;initialization.js&quot;]
</pre></div>
</div>
</section>
<section id="step-7-create-component-envelope">
<h2>Step 7. Create Component Envelope<a class="headerlink" href="#step-7-create-component-envelope" title="Link to this heading"></a></h2>
<p>The Component Envelope contains the meta-data required to automatically deploy and manage the component in an ODA-Canvas environment. The envelope will contain meta-data about the standard Kubernetes resources, as well as the TM Forum ODA extensions. There is a detailed breakdown of the Component Envelope in <a class="reference external" href="https://github.com/tmforum-oda/oda-ca-docs/blob/master/ODAComponentDesignGuidelines.md">ODAComponentDesignGuidelines</a>.</p>
<p>We will use <a class="reference external" href="https://helm.sh/">Helm</a> to create the component envelope as a Helm-Chart. This tutorial assumes you have already installed Helm on your local environment.</p>
<p>The first step is to use `helm create <chartname>’ which creates a boiler-plate chart:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>helm<span class="w"> </span>create<span class="w"> </span>productinventory
</pre></div>
</div>
<p>The boiler-plate should be visible under the productinventory folder. It contains a <code class="docutils literal notranslate"><span class="pre">Chart.yaml</span></code> (with meta-data about the chart) and a <code class="docutils literal notranslate"><span class="pre">values.yaml</span></code> (where we put any default parameters that we want to use). It also contains a <code class="docutils literal notranslate"><span class="pre">charts/</span></code> folder (empty) and a <code class="docutils literal notranslate"><span class="pre">templates/</span></code> folder (contining some boiler-plate Kubernetes templates).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Chart.yaml</span></code> will look something like the code below - no changes are required.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v2</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">productinventory</span>
<span class="nt">description</span><span class="p">:</span><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">A reference example TMFC005-ProductInventoryManagement ODA Component</span>

<span class="c1"># A chart can be either an &#39;application&#39; or a &#39;library&#39; chart.</span>
<span class="c1">#</span>
<span class="c1"># Application charts are a collection of templates that can be packaged into versioned archives</span>
<span class="c1"># to be deployed.</span>
<span class="c1">#</span>
<span class="c1"># Library charts provide useful utilities or functions for the chart developer. They&#39;re included as</span>
<span class="c1"># a dependency of application charts to inject those utilities and functions into the rendering</span>
<span class="c1"># pipeline. Library charts do not define any templates and therefore cannot be deployed.</span>
<span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">application</span>

<span class="c1"># This is the chart version. This version number should be incremented each time you make changes</span>
<span class="c1"># to the chart and its templates, including the app version.</span>
<span class="c1"># Versions are expected to follow Semantic Versioning (https://semver.org/)</span>
<span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.1.0</span><span class="w"> </span>
<span class="c1"># version: 1.1.0 - upgrade to v1beta3 spec</span>
<span class="c1"># version: 1.0.0 - baseline version</span>

<span class="c1"># This is the version number of the application being deployed. This version number should be</span>
<span class="c1"># incremented each time you make changes to the application. Versions are not expected to</span>
<span class="c1"># follow Semantic Versioning. They should reflect the version the application is using.</span>
<span class="c1"># It is recommended to use it with quotes.</span>
<span class="nt">appVersion</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.16.0&quot;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">values.yaml</span></code> file contains some sample parameters that are used in the template samples. Where you see a parameter in curly brackets in the templates file (e.g. <code class="docutils literal notranslate"><span class="pre">{{</span> <span class="pre">.Values.replicaCount</span> <span class="pre">}}</span></code>) - this will insert the value <code class="docutils literal notranslate"><span class="pre">replicaCount</span></code> from the values file into the template.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Charts/</span></code> folder lets you include existing Helm charts into your new chart - for example, we could include one of the standard MongoDb Helm charts (which would support a high-availability multi-node MongoDb deployment, for example). For simplicity during this tutorial we will leave <code class="docutils literal notranslate"><span class="pre">Charts/</span></code> empty.</p>
<p>Finally, most of the details we will create are in the <code class="docutils literal notranslate"><span class="pre">templates/</span></code> folder. Take a look inside this folder and you will see multiple sample templates:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">deployment</span><span class="o">.</span><span class="n">yaml</span>  
<span class="n">hpa</span><span class="o">.</span><span class="n">yaml</span>  
<span class="n">ingress</span><span class="o">.</span><span class="n">yaml</span> 
<span class="n">service</span><span class="o">.</span><span class="n">yaml</span> 
<span class="n">serviceaccount</span><span class="o">.</span><span class="n">yaml</span>  
</pre></div>
</div>
<p>For our Product Inventory component, we will create three deployments (one for the nodejs container that implements the core Product Inventory API, one for dependent PartyRole API, and one for the mongoDb).</p>
<p>Delete the <code class="docutils literal notranslate"><span class="pre">deployment.yaml</span></code> template and create three new templates called <code class="docutils literal notranslate"><span class="pre">deployment-productinventoryapi.yaml</span></code>, <code class="docutils literal notranslate"><span class="pre">deployment-partyroleapi.yaml</span></code> and the last one <code class="docutils literal notranslate"><span class="pre">deployment-mongodb.yaml</span></code>.</p>
<p>Copy the code below into  <code class="docutils literal notranslate"><span class="pre">deployment-productinventoryapi.yaml</span></code>. The file uses the <code class="docutils literal notranslate"><span class="pre">Release.Name</span></code> which is the name given to the instance of the component when deployed by Helm (we could potentially deploy multiple instances in the same ODA-Canvas). Note that we also pass the release name, component name etc as environment variables into the container.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-productinventoryapi</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">oda.tmforum.org/componentName</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-{{.Values.component.name}}</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">impl</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-productinventoryapi</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">impl</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-productinventoryapi</span>
<span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-{{.Values.component.name}}</span>
<span class="w">        </span><span class="nt">version</span><span class="p">:</span><span class="w">  </span><span class="l l-Scalar l-Scalar-Plain">productinventoryapi-0.2</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-productinventoryapi</span><span class="w">         </span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dominico/productinventoryapi:0.2</span>
<span class="w">        </span><span class="nt">env</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RELEASE_NAME</span>
<span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="w">           </span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">COMPONENT_NAME</span>
<span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-{{.Values.component.name}}</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MONGODB_HOST</span>
<span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-mongodb</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MONGODB_PORT</span>
<span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{.Values.mongodb.port}}&quot;</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MONGODB_DATABASE</span>
<span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Values.mongodb.database</span><span class="p p-Indicator">}}</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NODE_ENV</span>
<span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">production</span>
<span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span><span class="w">  </span>
<span class="w">        </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-prodinvapi</span>
<span class="w">          </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
</pre></div>
</div>
<p>Next, we need create the deployment resource for the party Role API. Copy the code below into <code class="docutils literal notranslate"><span class="pre">deployment-partyroleapi.yaml</span></code></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-partyroleapi</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">oda.tmforum.org/componentName</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-{{.Values.component.name}}</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">impl</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-partyroleapi</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-{{.Values.component.name}}</span>
<span class="w">        </span><span class="nt">impl</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-partyroleapi</span>
<span class="w">        </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Values.partyrole.versionlabel</span><span class="p p-Indicator">}}</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-partyroleapi</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Values.partyrole.image</span><span class="p p-Indicator">}}</span>
<span class="w">        </span><span class="nt">env</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RELEASE_NAME</span>
<span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="w">           </span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">COMPONENT_NAME</span>
<span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-{{.Values.component.name}}</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MONGODB_HOST</span>
<span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-mongodb</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MONGODB_PORT</span>
<span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{.Values.mongodb.port}}&quot;</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MONGODB_DATABASE</span>
<span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Values.mongodb.database</span><span class="p p-Indicator">}}</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NODE_ENV</span>
<span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">production</span><span class="w">           </span>
<span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
<span class="w">        </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-prapi</span>
<span class="w">          </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
<span class="w">        </span><span class="nt">startupProbe</span><span class="p">:</span>
<span class="w">          </span><span class="nt">httpGet</span><span class="p">:</span>
<span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/{{.Release.Name}}-{{.Values.component.name}}/tmf-api/partyRoleManagement/v4/partyRole</span><span class="w"> </span>
<span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
<span class="w">          </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="w">          </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span><span class="w">          </span>
<span class="w">          </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
</pre></div>
</div>
<p>We also need to deploy a mongoDb. We will use the standard mongoDb image from dockerhub. Copy the code below into: <code class="docutils literal notranslate"><span class="pre">deployment-partyroleapi.yaml</span></code></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-mongodb-prod</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">oda.tmforum.org/componentName</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-{{.Values.component.name}}</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">impl</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-mongodb</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">impl</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-mongodb</span>
<span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-{{.Values.component.name}}</span>
<span class="w">        </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo-latest</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-mongodb</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongo:latest</span>
<span class="w">        </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-mongodb</span>
<span class="w">          </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Values.mongodb.port</span><span class="p p-Indicator">}}</span>
<span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-mongodb-pv-storage</span>
<span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/data/db&quot;</span>
<span class="w">      </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-mongodb-pv-storage</span>
<span class="w">        </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span>
<span class="w">          </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-mongodb-pv-claim</span>
</pre></div>
</div>
<p>The mongoDb requires a persistentVolume and so we create a persistentVolumeClaim template <code class="docutils literal notranslate"><span class="pre">persistentVolumeClaim-mongodb.yaml</span></code>.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-mongodb-pv-claim</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">oda.tmforum.org/componentName</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-{{.Values.component.name}}</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
<span class="w">  </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">    </span><span class="nt">requests</span><span class="p">:</span>
<span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5Gi</span>
</pre></div>
</div>
<p>We need to make the mongoDb available to the nodejs productinventoryapi image, so we create a Kubernetes Service resource in <code class="docutils literal notranslate"><span class="pre">service-mongodb.yaml</span></code>. Note the service matches the connection url we created in step 3.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-mongodb</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">oda.tmforum.org/componentName</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-{{.Values.component.name}}</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-{{.Values.component.name}}</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Values.mongodb.port</span><span class="p p-Indicator">}}</span>
<span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-mongodb</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tcp-{{.Release.Name}}-mongodb</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NodePort</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">impl</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-mongodb</span>
</pre></div>
</div>
<p>We need to expose the product inventory API using a Service as well in <code class="docutils literal notranslate"><span class="pre">service-productinventoryapi.yaml</span></code>.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-productinventoryapi</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-productinventoryapi</span>
<span class="w">    </span><span class="nt">oda.tmforum.org/componentName</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-{{.Values.component.name}}</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
<span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-productinventoryapi</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NodePort</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">impl</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-productinventoryapi</span>
</pre></div>
</div>
<p>The party role API needs to be exposed using a service in <code class="docutils literal notranslate"><span class="pre">service-partyroleapi.yaml</span></code>.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-partyroleapi</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-partyroleapi</span>
<span class="w">    </span><span class="nt">oda.tmforum.org/componentName</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-{{.Values.component.name}}</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
<span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-prapi</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http-{{.Release.Name}}-partyroleapi</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NodePort</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">impl</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-partyroleapi</span>
</pre></div>
</div>
<p>Lastly, we create a kubernetes job resource in order to initialise a role using the party role API in <code class="docutils literal notranslate"><span class="pre">cronjob-roleinitialization.yaml</span></code></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">batch/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Job</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-roleinitialization</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">oda.tmforum.org/componentName</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-{{.Values.component.name}}</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-roleinitialization</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-roleinitialization</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dominico/roleinitialization:latest</span>
<span class="w">        </span><span class="nt">env</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RELEASE_NAME</span>
<span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="w">           </span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">COMPONENT_NAME</span>
<span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-{{.Values.component.name}}</span><span class="w">           </span>
<span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
<span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">OnFailure</span>
<span class="w">  </span><span class="nt">backoffLimit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
</pre></div>
</div>
<p>We have created all the Kubernetes resources to deploy the mongoDb, party role and product inventory nodejs containers and expose them as services. The final step is to add the ODA-Component meta-data. This meta-data will be used at run-time to configure the canvas services. Create the code below in <code class="docutils literal notranslate"><span class="pre">component-productinventory.yaml</span></code>.</p>
<p>This is a relatively simple component that just exposes one API as part of its <code class="docutils literal notranslate"><span class="pre">coreFunction</span></code>. Note that we have included the release name and component name in the root of the API path (this is a good pattern to follow so that the API doesn’t conflict with any other components deployed in the same environment).</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">oda.tmforum.org/v1beta3</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Component</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-{{.Values.component.name}}</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">oda.tmforum.org/componentName</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-{{.Values.component.name}}</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Values.component.id</span><span class="p p-Indicator">}}</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Values.component.name</span><span class="p p-Indicator">}}</span>
<span class="w">  </span><span class="nt">functionalBlock</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Values.component.functionalBlock</span><span class="p p-Indicator">}}</span>
<span class="w">  </span><span class="nt">publicationDate</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Values.component.publicationDate</span><span class="p p-Indicator">}}</span>
<span class="w">  </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">specified</span>
<span class="w">  </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Values.component.version</span><span class="p p-Indicator">}}</span>
<span class="w">  </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Simple</span><span class="nv"> </span><span class="s">Product</span><span class="nv"> </span><span class="s">Inventory</span><span class="nv"> </span><span class="s">ODA-Component</span><span class="nv"> </span><span class="s">from</span><span class="nv"> </span><span class="s">Open-API</span><span class="nv"> </span><span class="s">reference</span><span class="nv"> </span><span class="s">implementation.&quot;</span>
<span class="w">  </span><span class="nt">maintainers</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dominic Oyeniran</span>
<span class="w">      </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dominic.oyeniran@vodafone.com</span>
<span class="w">  </span><span class="nt">owners</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dominic Oyeniran</span>
<span class="w">      </span><span class="nt">email</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dominic.oyeniran@vodafone.com</span><span class="w">     </span>
<span class="w">  </span><span class="nt">coreFunction</span><span class="p">:</span>
<span class="w">    </span><span class="nt">exposedAPIs</span><span class="p">:</span><span class="w"> </span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">productinventorymanagement</span>
<span class="w">      </span><span class="nt">specification</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;https://raw.githubusercontent.com/tmforum-apis/TMF637_ProductInventory/master/TMF637-ProductInventory-v4.0.0.swagger.json&quot;</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">implementation</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-productinventoryapi</span>
<span class="w">      </span><span class="nt">apitype</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openapi</span>
<span class="w">      </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/{{.Release.Name}}-{{.Values.component.name}}/tmf-api/productInventory/v4</span>
<span class="w">      </span><span class="nt">developerUI</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/{{.Release.Name}}-{{.Values.component.name}}/tmf-api/productInventory/v4/docs</span>
<span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
<span class="w">    </span><span class="nt">dependentAPIs</span><span class="p">:</span><span class="w"> </span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">party</span>
<span class="w">      </span><span class="nt">apitype</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openapi</span><span class="w">        </span>
<span class="w">      </span><span class="nt">specification</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://open-api.tmforum.org/TMF632-Party-v4.0.0.swagger.json</span>
<span class="w">  </span><span class="nt">eventNotification</span><span class="p">:</span>
<span class="w">    </span><span class="nt">publishedEvents</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="w">    </span><span class="nt">subscribedEvents</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="w">  </span><span class="nt">managementFunction</span><span class="p">:</span><span class="w"> </span>
<span class="w">    </span><span class="nt">exposedAPIs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span>
<span class="w">    </span><span class="nt">dependentAPIs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w">   </span>
<span class="w">  </span><span class="nt">securityFunction</span><span class="p">:</span>
<span class="w">    </span><span class="nt">controllerRole</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Values.security.controllerRole</span><span class="w"> </span><span class="p p-Indicator">}}</span>
<span class="w">    </span><span class="nt">exposedAPIs</span><span class="p">:</span><span class="w"> </span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">partyrole</span>
<span class="w">      </span><span class="nt">specification</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;https://raw.githubusercontent.com/tmforum-apis/TMF669_PartyRole/master/TMF669-PartyRole-v4.0.0.swagger.json&quot;</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">implementation</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="nv">.Release.Name</span><span class="p p-Indicator">}}</span><span class="l l-Scalar l-Scalar-Plain">-partyroleapi</span>
<span class="w">      </span><span class="nt">apitype</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openapi</span>
<span class="w">      </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/{{.Release.Name}}-{{.Values.component.name}}/tmf-api/partyRoleManagement/v4</span>
<span class="w">      </span><span class="nt">developerUI</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/{{.Release.Name}}-{{.Values.component.name}}/tmf-api/partyRoleManagement/v4/docs</span>
<span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
</pre></div>
</div>
<p>Finally we have to create the parameters in the <code class="docutils literal notranslate"><span class="pre">values.yaml</span></code> file.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># Default values for productinventory.</span>
<span class="c1"># This is a YAML-formatted file.</span>
<span class="c1"># Declare variables to be passed into your templates.</span>

<span class="nt">component</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># Specifies whether a service account should be created</span>
<span class="w">  </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TMFC005</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">productinventory</span>
<span class="w">  </span><span class="nt">functionalBlock</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CoreCommerce</span>
<span class="w">  </span><span class="nt">publicationDate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2023-08-22T00:00:00.000Z</span>
<span class="w">  </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.0.1&quot;</span>
<span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="nt">security</span><span class="p">:</span>
<span class="w">  </span><span class="nt">controllerRole</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Admin</span>
<span class="nt">service</span><span class="p">:</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterIP</span>
<span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="nt">mongodb</span><span class="p">:</span>
<span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">27017</span>
<span class="w">  </span><span class="nt">database</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tmf</span>
<span class="nt">partyrole</span><span class="p">:</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lesterthomas/partyroleapi:1.0</span>
<span class="w">  </span><span class="nt">versionlabel</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">partyroleapi-1.0</span>
<span class="nt">api</span><span class="p">:</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dominico/productinventoryapi:latest</span>
<span class="w">  </span><span class="nt">versionlabel</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">productinventoryapi-0.2</span>
</pre></div>
</div>
</section>
<section id="step-6-test-component-envelope-using-component-ctk">
<h2>Step 6. Test component envelope using component CTK<a class="headerlink" href="#step-6-test-component-envelope-using-component-ctk" title="Link to this heading"></a></h2>
<p>The CTK will operate against an instance of the component. We can generate a kubernetes manifest of an instance using the <code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">template</span> <span class="pre">[instance</span> <span class="pre">namme]</span> <span class="pre">[chart]</span></code> command. We can take the output of this command into a temporary file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">helm</span> <span class="n">template</span> <span class="n">test</span> <span class="n">productinventory</span> <span class="o">&gt;</span> <span class="n">test</span><span class="o">-</span><span class="n">instance</span><span class="o">.</span><span class="n">component</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>If you examine the test-instance.component.yaml you will see all the kubernetes resources (deployments, services, persistentVolumeClaim) as well as a component resource. All the resources are labelled as belonging to the component. Also the component describes its core function (exposing a single API).</p>
<p>We can test that this component instance conforms to the ODA-Component standard by using the component CTK: Download the ODA-Component CTK from <a class="reference external" href="https://github.com/tmforum-oda/oda-component-ctk/">https://github.com/tmforum-oda/oda-component-ctk/</a>.</p>
<p>Within the oda-component-ctk folder, install the ctk.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>npm<span class="w"> </span>install
</pre></div>
</div>
<p>Then run the static ctk against the component envelope, you would need to specify the correct path to the <code class="docutils literal notranslate"><span class="pre">test-instance.component.yaml</span></code> created earlier.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>npm<span class="w"> </span>run<span class="w"> </span>L1-static<span class="w"> </span>../ProductInventory/test-instance.component.yaml
</pre></div>
</div>
<p>You should get an output like the image below. If you receive any errors, fix the issue in the helm chart yaml file and try again.</p>
<p><img alt="CTK image" src="../../_images/ctksuccess.png" /></p>
</section>
<section id="step-8-deploy-the-component-envelope-into-open-digital-lab-canvas">
<h2>Step 8. Deploy the component envelope into Open Digital Lab canvas<a class="headerlink" href="#step-8-deploy-the-component-envelope-into-open-digital-lab-canvas" title="Link to this heading"></a></h2>
<p>Connect to the Open Digital Lab: Get the kubectl config from the rancher environment at <a class="reference external" href="https://rke.tmforum.org/c/c-85kcq/monitoring">https://rke.tmforum.org/c/c-85kcq/monitoring</a> - click the Kubeconfig File button in the top right:</p>
<p><img alt="Rancher" src="../../_images/Rancher.png" /></p>
<p>Copy this into your <code class="docutils literal notranslate"><span class="pre">~/.kube/config</span></code> file.</p>
<p>You can test the connection using <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">all</span> <span class="pre">--namespace</span> <span class="pre">components</span></code>. (You should either see a message <code class="docutils literal notranslate"><span class="pre">No</span> <span class="pre">resources</span> <span class="pre">found</span> <span class="pre">in</span> <span class="pre">components</span> <span class="pre">namespace.</span></code> or you may retrieve a list of kubernetes resources).</p>
<p>To permanently save the namespace for all subsequent kubectl commands use:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>config<span class="w"> </span>set-context<span class="w"> </span>--current<span class="w"> </span>--namespace<span class="o">=</span>components
</pre></div>
</div>
<p>Install the component using Helm, we call the release name <code class="docutils literal notranslate"><span class="pre">r1</span></code> . Ensure the release name is not in conflict with release name already assigned to other components in the open digital lab:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>helm<span class="w"> </span>install<span class="w"> </span>r1<span class="w"> </span>productinventory/<span class="w"> </span>
</pre></div>
</div>
<p>You can then view the component in <code class="docutils literal notranslate"><span class="pre">kubectl</span></code>:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>get<span class="w"> </span>components
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">components</span></code> will show all the deployed components and the deployment status. Initially these details will be blank - the component may take a few seconds to fully deploy. Once deployed, it should look like:</p>
<p><img alt="get components" src="../../_images/kubectl-get-components.png" /></p>
<p>You can also view the component API endpoint in <code class="docutils literal notranslate"><span class="pre">kubectl</span></code>:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>get<span class="w"> </span>apis
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">apis</span></code> command shows details of exposed apis and a developer-ui (if supplied). Initially these details will be blank - the component may take a few seconds to fully deploy. Once deployed, it should look like:</p>
<p><img alt="get apis" src="../../_images/kubectl-get-apis.png" /></p>
<p>If you navigate to the root or the API (in a web browser or in postman), you should see the entrypoint of the API:</p>
<p><img alt="api entrypoint" src="../../_images/api-entrypoint.png" /></p>
<p>If you navigate to the developer-ui, you shold see the swagger-ui tool:</p>
<p><img alt="swagger ui" src="../../_images/swagger-ui.png" /></p>
<p>Finally, you can run the dynamic ctk against the component envelope.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>npm<span class="w"> </span>dynamic<span class="w"> </span>../oda-ca-docs/ODA-Component-Tutorial/test-instance.component.yaml
</pre></div>
</div>
<p>You should get a result like the image below:</p>
<p><img alt="CTK image" src="../../_images/ctkdynamicsuccess.png" /></p>
<p>This is the last step. You would have succesffully deployed an ODA Component unto an ODA Canvas environment!</p>
</section>
<section id="directory-structure">
<h2>Directory Structure<a class="headerlink" href="#directory-structure" title="Link to this heading"></a></h2>
<p>The high level directory structure for our reference implementation is depicted below.</p>
<p><img alt="Implementation directory image" src="../../_images/folderstructure.png" /></p>
<p>Also, the reference implementation sourcecode is available on the <a class="reference external" href="https://github.com/tmforum-oda/oda-ca-docs/tree/master/ODA-Component-Tutorial/ProductInventory">ODA-Component-Tutorial Git Hub Repo</a></p>
</section>
<section id="issues-resolution">
<h2>ISSUES &amp; resolution<a class="headerlink" href="#issues-resolution" title="Link to this heading"></a></h2>
<ol class="arabic simple">
<li><p>Kubernetes ingress expect a 200 response at the root of the API. Without this, they do not create an ingress and instead return a 503 error.  An additional ‘entrypoint’ middleware hook in the index.js has been created to resolve this. This returns an entrypoint (or homepage) response for the API (following the TMF630 Design Guidelines).</p></li>
</ol>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">// create an entrypoint</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;app.use entrypoint&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">swaggerDoc</span><span class="p">.</span><span class="nx">basePath</span><span class="p">,</span><span class="w"> </span><span class="nx">entrypointUtils</span><span class="p">.</span><span class="nx">entrypoint</span><span class="p">);</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Due to a node version issue (i think!) the generated API RI does not work on the latest v15 of node. I have created container based on node v12. The issue is with the fs.copyFileSync function: The v15 expects the third parameter to be an optional <code class="docutils literal notranslate"><span class="pre">mode</span></code> whilst the current implementation has a call-back error function.</p></li>
<li><p>Api-docs are exposed at /api-docs which means that you can’t host multiple apis on the same server. Therefore, it is hosted at <code class="docutils literal notranslate"><span class="pre">tmf-api/productInventory/v4/api-docs</span></code> instead (and the swagger-ui at <code class="docutils literal notranslate"><span class="pre">tmf-api/productInventory/v4/docs</span></code>).</p></li>
<li><p>The component name has been included in the root of the API (so that multiple instances of the API can be deployed in the same server). For a Helm install with release name <code class="docutils literal notranslate"><span class="pre">test</span></code>, the api is deployed at: <code class="docutils literal notranslate"><span class="pre">/test-productinventory/tmf-api/productInventory/v4/</span></code> and with a Helm install with release name <code class="docutils literal notranslate"><span class="pre">r1</span></code>, the api is deployed at: <code class="docutils literal notranslate"><span class="pre">/test-productinventory/tmf-api/productInventory/v4/</span></code> . Component release name must be unique and cannot be reused.</p></li>
</ol>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../Observability-Tutorial/README.html" class="btn btn-neutral float-left" title="Tutorial to deploy and observe a running component" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../ODAComponentDesignGuidelines.html" class="btn btn-neutral float-right" title="Design Guidelines to create a new ODA Component" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, TM Forum ODA-Component Accelerator project.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>