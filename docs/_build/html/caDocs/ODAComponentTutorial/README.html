

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Tutorial to build ODA-Component from Open-API Reference Implemenation &mdash; ODA-Component Accelerator v1alpha2 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Design Guidelines to create a new ODA Component" href="../ODAComponentDesignGuidelines.html" />
    <link rel="prev" title="Introduction to the ODA-CA" href="../README.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> ODA-Component Accelerator
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">About the project (Playbook):</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../README.html">Introduction to the ODA-CA</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorial:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tutorial to build ODA-Component from Open-API Reference Implemenation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#step-1-download-reference-implementation">Step 1. Download Reference Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#step-2-optionally-test-locally-with-local-mongodb">Step 2. (optionally) test locally with local MongoDb.</a></li>
<li class="toctree-l2"><a class="reference internal" href="#step-3-configure-for-use-within-kubernetes">Step 3. Configure for use within Kubernetes.</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#configure-mongodb-connection-url-to-use-within-kubernetes">3.1 Configure mongoDb connection url to use within Kubernetes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#use-environment-variables-to-allow-api-path-to-be-configured-externally">3.2 Use environment variables to allow API path to be configured externally</a></li>
<li class="toctree-l3"><a class="reference internal" href="#add-home-resource-at-root-of-the-api-and-also-move-where-the-docs-and-api-docs-are-hosted">3.3 Add home resource at root of the API, and also move where the docs and api-docs are hosted</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#step-4-package-the-nodejs-implementation-into-a-docker-image">Step 4. Package the nodejs implementation into a docker image</a></li>
<li class="toctree-l2"><a class="reference internal" href="#step-5-create-component-envelope">Step 5. Create Component Envelope</a></li>
<li class="toctree-l2"><a class="reference internal" href="#step-6-test-component-envelope-using-component-ctk">Step 6. Test component envelope using component CTK</a></li>
<li class="toctree-l2"><a class="reference internal" href="#step-7-deploy-the-component-envelope-into-open-digital-lab-canvas">Step 7. Deploy the component envelope into Open Digital Lab canvas</a></li>
<li class="toctree-l2"><a class="reference internal" href="#issues-resolution">ISSUES &amp; resolution</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Design Guidelines:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../ODAComponentDesignGuidelines.html">Design Guidelines to create a new ODA Component</a></li>
</ul>
<p class="caption"><span class="caption-text">Canvas Operators:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../caSource/controllers/index.html">Open Digital Architecture - Controllers/Operators</a></li>
</ul>
<p class="caption"><span class="caption-text">Contributions Guide:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../ContributionsGuide.html">Contribution guidance</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ODA-Component Accelerator</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Tutorial to build ODA-Component from Open-API Reference Implemenation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/caDocs/ODAComponentTutorial/README.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="tutorial-to-build-oda-component-from-open-api-reference-implemenation">
<h1>Tutorial to build ODA-Component from Open-API Reference Implemenation<a class="headerlink" href="#tutorial-to-build-oda-component-from-open-api-reference-implemenation" title="Permalink to this headline">¶</a></h1>
<p>This tutorial shows the complete process to package, test and deploy an ODA-Component, using the nodejs reference implementation of the TMF620 Product Catalog Management API as the source code. You should be able to follow the process below using an existing software application as source (the process should work for simple applications - it is intended as a tutorial to get you started; For more complex applications you may have to decompose to multiple containers/micro-services and even multiple ODA-Components).</p>
<p>There is a video of this tutorial at: <a class="reference external" href="https://youtu.be/wZJ8d5uQ7_8">ODA Component Tutorial Video walkthrough</a></p>
<p>For an introdution to the Open-Digital Architecture component model, take a look at the recording from the Digital Transformation World Series conference:</p>
<p><img alt="https://www.youtube.com/watch?v=e_m-nnKvWIs" src="../../_images/DTW-Video.png" /></p>
<p><a class="reference external" href="https://www.youtube.com/watch?v=e_m-nnKvWIs">DTW World Series Masterclass</a></p>
<div class="section" id="step-1-download-reference-implementation">
<h2>Step 1. Download Reference Implementation<a class="headerlink" href="#step-1-download-reference-implementation" title="Permalink to this headline">¶</a></h2>
<p>We are using one of the Reference implementaitons of the Open-APIs as a starting point. Go to the open-API Table at <a class="reference external" href="https://projects.tmforum.org/wiki/display/API/Open+API+Table">https://projects.tmforum.org/wiki/display/API/Open+API+Table</a> and download one of the reference implmeentation <code class="docutils literal notranslate"><span class="pre">.zip</span></code> files (we are using the Product Catalog Management API, but you can choose any).</p>
<p><img alt="&lt;img src=&quot;https://projects.tmforum.org/wiki/display/API/Open+API+Table&quot;&gt;" src="../../_images/Open-API-Table.png" /></p>
<p>The reference implementation provides a Nodejs API server implementation that requires a MongoDb backend. It provides a nice swagger-ui on top of a Open-API implementation stub.</p>
<p><img alt="Open-API Reference Implementation" src="../../_images/Reference-Implementation.png" /></p>
<p>The reference implementation is set-up to run in IBM Cloud (bluemix). To enable it to run locally or in a docker container, we edit the /api/swagger.yaml file to remove the <code class="docutils literal notranslate"><span class="pre">host:</span></code> field (it will default to looking in the current host), and change the <code class="docutils literal notranslate"><span class="pre">schemes:</span></code> from <code class="docutils literal notranslate"><span class="pre">https</span></code> to <code class="docutils literal notranslate"><span class="pre">http</span></code>.</p>
</div>
<div class="section" id="step-2-optionally-test-locally-with-local-mongodb">
<h2>Step 2. (optionally) test locally with local MongoDb.<a class="headerlink" href="#step-2-optionally-test-locally-with-local-mongodb" title="Permalink to this headline">¶</a></h2>
<p>In the <code class="docutils literal notranslate"><span class="pre">utils/mongoUtils.js</span></code> file, you will need to replace the connectHelper with a helper function that uses local connection string:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/*</span> <span class="n">connection</span> <span class="n">helper</span> <span class="k">for</span> <span class="n">running</span> <span class="n">MongoDb</span> <span class="kn">from</span> <span class="nn">url</span> <span class="o">*/</span>
<span class="n">function</span> <span class="n">connectHelper</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">var</span> <span class="n">credentials_uri</span> <span class="o">=</span> <span class="s2">&quot;mongodb://localhost:27017/tmf&quot;</span><span class="p">;</span>
  <span class="n">let</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">useNewUrlParser</span><span class="p">:</span> <span class="n">true</span> 
  <span class="p">};</span>
  <span class="n">MongoClient</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">credentials_uri</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">function</span> <span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">mongodb</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
      <span class="n">callback</span><span class="p">(</span><span class="n">err</span><span class="p">,</span><span class="n">null</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">mongodb</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">db</span><span class="p">(</span><span class="s2">&quot;tmf&quot;</span><span class="p">);</span>
      <span class="n">callback</span><span class="p">(</span><span class="n">null</span><span class="p">,</span><span class="n">mongodb</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can then test the API by using <code class="docutils literal notranslate"><span class="pre">npm</span> <span class="pre">install</span></code> and <code class="docutils literal notranslate"><span class="pre">npm</span> <span class="pre">start</span></code>. You should be able to view the API in a browser by browsing to <a class="reference external" href="http://localhost:8080/docs">http://localhost:8080/docs</a>.</p>
</div>
<div class="section" id="step-3-configure-for-use-within-kubernetes">
<h2>Step 3. Configure for use within Kubernetes.<a class="headerlink" href="#step-3-configure-for-use-within-kubernetes" title="Permalink to this headline">¶</a></h2>
<p>When we depoy this nodejs code for use within Kubernetes, it will connect to MongoDb using a url which is provided by a Kubernetes service. We also use environment variable to allow Kubernetes to, for example, determine the path where the API is exposed.</p>
<div class="section" id="configure-mongodb-connection-url-to-use-within-kubernetes">
<h3>3.1 Configure mongoDb connection url to use within Kubernetes<a class="headerlink" href="#configure-mongodb-connection-url-to-use-within-kubernetes" title="Permalink to this headline">¶</a></h3>
<p>In the <code class="docutils literal notranslate"><span class="pre">utils/mongoUtils.js</span></code> file, you will need to update the local connection string to a url that wil work within Kubernetes (this will match the kubernetes service name for mongoDb). Note we include a release name passed as an environment variable (as we could potentially deploy multiple instances of a component in the same canvas).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/*</span> <span class="n">connection</span> <span class="n">helper</span> <span class="k">for</span> <span class="n">running</span> <span class="n">MongoDb</span> <span class="kn">from</span> <span class="nn">url</span> <span class="o">*/</span>
<span class="n">function</span> <span class="n">connectHelper</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">var</span> <span class="n">releaseName</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">RELEASE_NAME</span><span class="p">;</span> <span class="o">//</span> <span class="n">Release</span> <span class="n">name</span> <span class="kn">from</span> <span class="nn">Helm</span> <span class="n">deployment</span>
  <span class="n">var</span> <span class="n">credentials_uri</span> <span class="o">=</span> <span class="s2">&quot;mongodb://&quot;</span> <span class="o">+</span> <span class="n">releaseName</span> <span class="o">+</span> <span class="s2">&quot;-mongodb:27017/tmf&quot;</span><span class="p">;</span>
  <span class="n">let</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">useNewUrlParser</span><span class="p">:</span> <span class="n">true</span> 
  <span class="p">};</span>
  <span class="n">MongoClient</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">credentials_uri</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">function</span> <span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">mongodb</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
      <span class="n">callback</span><span class="p">(</span><span class="n">err</span><span class="p">,</span><span class="n">null</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">mongodb</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">db</span><span class="p">(</span><span class="s2">&quot;tmf&quot;</span><span class="p">);</span>
      <span class="n">callback</span><span class="p">(</span><span class="n">null</span><span class="p">,</span><span class="n">mongodb</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="use-environment-variables-to-allow-api-path-to-be-configured-externally">
<h3>3.2 Use environment variables to allow API path to be configured externally<a class="headerlink" href="#use-environment-variables-to-allow-api-path-to-be-configured-externally" title="Permalink to this headline">¶</a></h3>
<p>By default the nodejs code will serve the API at the path in the swagger file, which for our example is <code class="docutils literal notranslate"><span class="pre">/tmf-api/productCatalogManagement/v4/</span></code>. We want to potentially deploy multiple component instances in the same environment, and so we add a configurable <code class="docutils literal notranslate"><span class="pre">COMPONENT_NAME</span></code> to the start of the URL. We need to do this in the <code class="docutils literal notranslate"><span class="pre">swaggerDoc</span></code> as well as in the <code class="docutils literal notranslate"><span class="pre">swagger-ui-dist/index.html</span></code> that provides the swagger user interface.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">swaggerDoc</span> <span class="o">=</span> <span class="n">swaggerUtils</span><span class="o">.</span><span class="n">getSwaggerDoc</span><span class="p">();</span>

<span class="o">//</span> <span class="n">Get</span> <span class="n">Component</span> <span class="n">instance</span> <span class="n">name</span> <span class="kn">from</span> <span class="nn">Environment</span> <span class="n">variable</span> <span class="ow">and</span> <span class="n">put</span> <span class="n">it</span> <span class="n">at</span> <span class="n">start</span> <span class="n">of</span> <span class="n">API</span> <span class="n">path</span>
<span class="n">var</span> <span class="n">componentName</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">COMPONENT_NAME</span><span class="p">;</span> 
<span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;ComponentName:&#39;</span><span class="o">+</span><span class="n">componentName</span><span class="p">);</span>

<span class="n">swaggerDoc</span><span class="o">.</span><span class="n">basePath</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">componentName</span> <span class="o">+</span> <span class="n">swaggerDoc</span><span class="o">.</span><span class="n">basePath</span>

<span class="o">//</span> <span class="n">add</span> <span class="n">component</span> <span class="n">name</span> <span class="n">to</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">swagger_ui</span>
<span class="n">fs</span><span class="o">.</span><span class="n">readFile</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">__dirname</span><span class="p">,</span> <span class="s1">&#39;./node_modules/swagger-ui-dist/index.html&#39;</span><span class="p">),</span> <span class="s1">&#39;utf8&#39;</span><span class="p">,</span> <span class="n">function</span> <span class="p">(</span><span class="n">err</span><span class="p">,</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">var</span> <span class="n">result</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">/</span>\<span class="o">/</span><span class="n">api</span><span class="o">-</span><span class="n">docs</span><span class="o">/</span><span class="n">g</span><span class="p">,</span> <span class="n">swaggerDoc</span><span class="o">.</span><span class="n">basePath</span> <span class="o">+</span> <span class="s1">&#39;api-docs&#39;</span> <span class="p">);</span>
  <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;updating &#39;</span> <span class="o">+</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">__dirname</span><span class="p">,</span> <span class="s1">&#39;./node_modules/swagger-ui-dist/index.html&#39;</span><span class="p">));</span>
  <span class="n">fs</span><span class="o">.</span><span class="n">writeFile</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">__dirname</span><span class="p">,</span> <span class="s1">&#39;./node_modules/swagger-ui-dist/index.html&#39;</span><span class="p">),</span> <span class="n">result</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">,</span> <span class="n">function</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="k">return</span> <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div>
</div>
</div>
<div class="section" id="add-home-resource-at-root-of-the-api-and-also-move-where-the-docs-and-api-docs-are-hosted">
<h3>3.3 Add home resource at root of the API, and also move where the docs and api-docs are hosted<a class="headerlink" href="#add-home-resource-at-root-of-the-api-and-also-move-where-the-docs-and-api-docs-are-hosted" title="Permalink to this headline">¶</a></h3>
<p>By default, the swagger tools expose a resource at all the paths in the API (defined in the swagger.yaml file); They don’t offer any response at the root of the API. This can make it harder for a developer to discover the API paths. In addition, a Kubernetes ingress will by default test the root of the API (as a liveness test). If it receives no response, it will assume the microservice is dead and will not route any traffic to it. A simple solution is to create a home resource that provides a set of links to the other API endpoints. The TM Forum Open-API design standards (TMF630) provides a good definition of this resource which is called the <code class="docutils literal notranslate"><span class="pre">home</span></code> or <code class="docutils literal notranslate"><span class="pre">entrypoint</span></code> resource.</p>
<p>I’ve created a simple module in <code class="docutils literal notranslate"><span class="pre">utils/entrypoint.js</span></code> to build this entrypoint resource at run-time from the swagger.yaml. Operating at run-time also allows you to send a contextual response (that might vary depending on the role of the user, for example).</p>
<p>You integrate this module by adding <code class="docutils literal notranslate"><span class="pre">app.use(swaggerDoc.basePath,</span> <span class="pre">entrypointUtils.entrypoint);</span></code> as the last hook before starting the server.</p>
<p>Finally, we change the path where the ‘api-docs’ and ‘docs’ are exposed. By default they are served at <code class="docutils literal notranslate"><span class="pre">/api-docs</span></code> and <code class="docutils literal notranslate"><span class="pre">/docs</span></code>. Again, we want to avoid conflicts if we have multiple components running in the same environment. We solve this by moving them to the full path of the API, so in our example, they would be at <code class="docutils literal notranslate"><span class="pre">/tmf-api/productCatalogManagement/v4/</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="o">//</span> <span class="n">Serve</span> <span class="n">the</span> <span class="n">Swagger</span> <span class="n">documents</span> <span class="ow">and</span> <span class="n">Swagger</span> <span class="n">UI</span>
  <span class="n">app</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">middleware</span><span class="o">.</span><span class="n">swaggerUi</span><span class="p">({</span>   <span class="n">apiDocs</span><span class="p">:</span> <span class="n">swaggerDoc</span><span class="o">.</span><span class="n">basePath</span> <span class="o">+</span> <span class="s1">&#39;api-docs&#39;</span><span class="p">,</span>
    <span class="n">swaggerUi</span><span class="p">:</span> <span class="n">swaggerDoc</span><span class="o">.</span><span class="n">basePath</span> <span class="o">+</span> <span class="s1">&#39;docs&#39;</span><span class="p">,</span>
    <span class="n">swaggerUiDir</span><span class="p">:</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">__dirname</span><span class="p">,</span> <span class="s1">&#39;node_modules&#39;</span><span class="p">,</span> <span class="s1">&#39;swagger-ui-dist&#39;</span><span class="p">)</span> <span class="p">}));</span>

  <span class="o">//</span> <span class="n">create</span> <span class="n">an</span> <span class="n">entrypoint</span>
  <span class="n">const</span> <span class="n">entrypointUtils</span> <span class="o">=</span> <span class="n">require</span><span class="p">(</span><span class="s1">&#39;./utils/entrypoint&#39;</span><span class="p">);</span>
  <span class="n">app</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">swaggerDoc</span><span class="o">.</span><span class="n">basePath</span><span class="p">,</span> <span class="n">entrypointUtils</span><span class="o">.</span><span class="n">entrypoint</span><span class="p">);</span>

    <span class="o">//</span> <span class="n">Start</span> <span class="n">the</span> <span class="n">server</span>
  <span class="n">http</span><span class="o">.</span><span class="n">createServer</span><span class="p">(</span><span class="n">app</span><span class="p">)</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">serverPort</span><span class="p">,</span> <span class="n">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Your server is listening on port </span><span class="si">%d</span><span class="s1"> (http://localhost:</span><span class="si">%d</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">serverPort</span><span class="p">,</span> <span class="n">serverPort</span><span class="p">);</span>
    <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;Swagger-ui is available on http://localhost:&#39;</span><span class="o">+</span> <span class="n">serverPort</span>  <span class="o">+</span> <span class="n">swaggerDoc</span><span class="o">.</span><span class="n">basePath</span> <span class="o">+</span> <span class="s1">&#39;docs&#39;</span><span class="p">,</span> <span class="n">serverPort</span><span class="p">);</span>
  <span class="p">});</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="step-4-package-the-nodejs-implementation-into-a-docker-image">
<h2>Step 4. Package the nodejs implementation into a docker image<a class="headerlink" href="#step-4-package-the-nodejs-implementation-into-a-docker-image" title="Permalink to this headline">¶</a></h2>
<p>Create a dockerfile with the instructions to build our image. We are starting with the official <a class="reference external" href="https://hub.docker.com/_/node">node</a> docker image.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FROM</span> <span class="n">node</span><span class="p">:</span><span class="mi">10</span>
</pre></div>
</div>
<p>This image comes with Node.js and NPM already installed so the next thing we need to do is to install the app dependencies.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">COPY</span> <span class="n">implementation</span><span class="o">/</span><span class="n">package</span><span class="o">*.</span><span class="n">json</span> <span class="o">.</span>
<span class="n">RUN</span> <span class="n">npm</span> <span class="n">install</span>
</pre></div>
</div>
<p>Then we copy the source code.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">COPY</span> <span class="n">implementation</span> <span class="o">./</span>
</pre></div>
</div>
<p>The app binds to port 8080 so we’ll use the EXPOSE instruction to have it mapped by the docker daemon:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">EXPOSE</span> <span class="mi">8080</span>
</pre></div>
</div>
<p>Finally we define the command that will run the app.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CMD</span> <span class="p">[</span><span class="s2">&quot;node&quot;</span><span class="p">,</span> <span class="s2">&quot;index.js&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>The complete dockerfile should look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FROM</span> <span class="n">node</span><span class="p">:</span><span class="mi">10</span>
<span class="n">COPY</span> <span class="n">implementation</span><span class="o">/</span><span class="n">package</span><span class="o">*.</span><span class="n">json</span> <span class="o">.</span>
<span class="n">RUN</span> <span class="n">npm</span> <span class="n">install</span>
<span class="n">COPY</span> <span class="n">implementation</span> <span class="o">./</span>
<span class="n">EXPOSE</span> <span class="mi">8080</span>
<span class="n">CMD</span> <span class="p">[</span><span class="s2">&quot;node&quot;</span><span class="p">,</span> <span class="s2">&quot;index.js&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>Before we build this dockerfile, we create a <code class="docutils literal notranslate"><span class="pre">.dockerignore</span></code> file (so the at node_modules packages are not copied into the docker image - this would make the image very large. The <code class="docutils literal notranslate"><span class="pre">RUN</span> <span class="pre">npm</span> <span class="pre">install</span></code> command inside the dockerfile will install these on demand).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">node_modules</span>
<span class="n">npm</span><span class="o">-</span><span class="n">debug</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
<p>To build the docker image, we use the command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">build</span> <span class="o">-</span><span class="n">t</span> <span class="n">lesterthomas</span><span class="o">/</span><span class="n">productcatalogapi</span><span class="p">:</span><span class="mf">0.1</span> <span class="o">-</span><span class="n">t</span> <span class="n">lesterthomas</span><span class="o">/</span><span class="n">productcatalogapi</span><span class="p">:</span><span class="n">latest</span> <span class="o">-</span><span class="n">f</span> <span class="n">dockerfile</span> <span class="o">.</span>
</pre></div>
</div>
<p>Note: we use the -t to tag the image. We give the image two tags, one with a version number and the other with a <code class="docutils literal notranslate"><span class="pre">latest</span></code> tag that will overwrite any previously uploaded images.</p>
<p>Finally we upload the docker image to a Docker repository. I’m using the default <a class="reference external" href="https://hub.docker.com">DockerHub</a> with an account <code class="docutils literal notranslate"><span class="pre">lesterthomas</span></code> that I have created previously. If this is the first time accessing the docker repository you will need to login first with the <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">login</span></code> command.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">push</span> <span class="n">lesterthomas</span><span class="o">/</span><span class="n">productcatalogapi</span> <span class="o">--</span><span class="nb">all</span><span class="o">-</span><span class="n">tags</span>
</pre></div>
</div>
</div>
<div class="section" id="step-5-create-component-envelope">
<h2>Step 5. Create Component Envelope<a class="headerlink" href="#step-5-create-component-envelope" title="Permalink to this headline">¶</a></h2>
<p>The Component Envelope contains the meta-data required to automatically deploy and manage the component in an ODA-Canvas environment. The envelope will contain meta-data about the standard Kubernetes resources, as well as the TM Forum ODA extensions. There is a detailed breakdown of the Component Envelope in <a class="reference external" href="https://github.com/tmforum-oda/oda-ca-docs/blob/master/ODAComponentDesignGuidelines.md">ODAComponentDesignGuidelines</a>.</p>
<p>We will use <a class="reference external" href="https://helm.sh/">Helm</a> to create the component envelope as a Helm-Chart. This tutorial assumes you have already installed Helm on your local environment.</p>
<p>The first step is to use `helm create <chartname>’ which creates a boiler-plate chart:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">helm</span> <span class="n">create</span> <span class="n">productcatalog</span>
</pre></div>
</div>
<p>The boiler-plate should be visible under the productcatalog folder. It contains a <code class="docutils literal notranslate"><span class="pre">Chart.yaml</span></code> (with meta-data about the chart) and a <code class="docutils literal notranslate"><span class="pre">values.yaml</span></code> (where we put any default parameters that we want to use). It also contains a <code class="docutils literal notranslate"><span class="pre">charts/</span></code> folder (empty) and a <code class="docutils literal notranslate"><span class="pre">templates/</span></code> folder (contining some boiler-plate Kubernetes templates).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Chart.yaml</span></code> will look something like the code below - no changes are required.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v2</span>
<span class="n">name</span><span class="p">:</span> <span class="n">productcatalog</span>
<span class="n">description</span><span class="p">:</span> <span class="n">A</span> <span class="n">Helm</span> <span class="n">chart</span> <span class="k">for</span> <span class="n">Kubernetes</span>

<span class="c1"># A chart can be either an &#39;application&#39; or a &#39;library&#39; chart.</span>
<span class="c1">#</span>
<span class="c1"># Application charts are a collection of templates that can be packaged into versioned archives</span>
<span class="c1"># to be deployed.</span>
<span class="c1">#</span>
<span class="c1"># Library charts provide useful utilities or functions for the chart developer. They&#39;re included as</span>
<span class="c1"># a dependency of application charts to inject those utilities and functions into the rendering</span>
<span class="c1"># pipeline. Library charts do not define any templates and therefore cannot be deployed.</span>
<span class="nb">type</span><span class="p">:</span> <span class="n">application</span>

<span class="c1"># This is the chart version. This version number should be incremented each time you make changes</span>
<span class="c1"># to the chart and its templates, including the app version.</span>
<span class="c1"># Versions are expected to follow Semantic Versioning (https://semver.org/)</span>
<span class="n">version</span><span class="p">:</span> <span class="mf">0.1</span><span class="o">.</span><span class="mi">0</span>

<span class="c1"># This is the version number of the application being deployed. This version number should be</span>
<span class="c1"># incremented each time you make changes to the application. Versions are not expected to</span>
<span class="c1"># follow Semantic Versioning. They should reflect the version the application is using.</span>
<span class="c1"># It is recommended to use it with quotes.</span>
<span class="n">appVersion</span><span class="p">:</span> <span class="s2">&quot;1.16.0&quot;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">values.yaml</span></code> file contains some sample parameters that are used in the template samples. Where you see a parameter in curly brackets in the templates file (e.g. <code class="docutils literal notranslate"><span class="pre">{{</span> <span class="pre">.Values.replicaCount</span> <span class="pre">}}</span></code>) - this will insert the value <code class="docutils literal notranslate"><span class="pre">replicaCount</span></code> from the values file into the template.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Charts/</span></code> folder lets you include existing Helm charts into your new chart - for example, we could include one of the standard MongoDb Helm charts (which would support a high-availability multi-node MongoDb deployment, for example). For simplicity during this tutorial we will leave <code class="docutils literal notranslate"><span class="pre">Charts/</span></code> empty.</p>
<p>Funally, most of the details we will create are in the <code class="docutils literal notranslate"><span class="pre">templates/</span></code> folder. Take a look inside this folder and you will see multiple sample templates:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">deployment</span><span class="o">.</span><span class="n">yaml</span>  
<span class="n">hpa</span><span class="o">.</span><span class="n">yaml</span>  
<span class="n">ingress</span><span class="o">.</span><span class="n">yaml</span>  
<span class="n">serviceaccount</span><span class="o">.</span><span class="n">yaml</span>  
<span class="n">service</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>For our Product Catalog component, we will create two deployments (one for the nodejs container that implements the API, and one for the mongoDb).</p>
<p>Delete the the <code class="docutils literal notranslate"><span class="pre">deployment.yaml</span></code> template and create two new templates called <code class="docutils literal notranslate"><span class="pre">deployment-productcatalogapi.yaml</span></code> and the other <code class="docutils literal notranslate"><span class="pre">deployment-mongodb.yaml</span></code>.</p>
<p>Copy the code below into  <code class="docutils literal notranslate"><span class="pre">deployment-productcatalogapi.yaml</span></code>. I’ve chosen to only parameterise the <code class="docutils literal notranslate"><span class="pre">component.type</span></code> field (a production heml chart would typically parameterize many more values). The file also uses the <code class="docutils literal notranslate"><span class="pre">Release.Name</span></code> which is the name given to the instance of the component when deployed by Helm (we could potenticlly deploy multiple instanaces in the same ODA-Canvas). Note that we also pass the release name and component name as environment variables into the container.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">apps</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="n">productcatalogapi</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">oda</span><span class="o">.</span><span class="n">tmforum</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">componentName</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="p">{{</span><span class="o">.</span><span class="n">Values</span><span class="o">.</span><span class="n">component</span><span class="o">.</span><span class="n">type</span><span class="p">}}</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">replicas</span><span class="p">:</span> <span class="mi">1</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">matchLabels</span><span class="p">:</span>
      <span class="n">app</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="n">productcatalogapi</span>
  <span class="n">template</span><span class="p">:</span>
    <span class="n">metadata</span><span class="p">:</span>
      <span class="n">labels</span><span class="p">:</span>
        <span class="n">app</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="n">productcatalogapi</span>
    <span class="n">spec</span><span class="p">:</span>
      <span class="n">containers</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="n">productcatalogapi</span>
        <span class="n">env</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">RELEASE_NAME</span>
          <span class="n">value</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span>           
        <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">COMPONENT_NAME</span>
          <span class="n">value</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="p">{{</span><span class="o">.</span><span class="n">Values</span><span class="o">.</span><span class="n">component</span><span class="o">.</span><span class="n">type</span><span class="p">}}</span>           
        <span class="n">image</span><span class="p">:</span> <span class="n">lesterthomas</span><span class="o">/</span><span class="n">productcatalogapi</span><span class="p">:</span><span class="n">latest</span>
        <span class="n">ports</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="n">productcatalogapi</span>
          <span class="n">containerPort</span><span class="p">:</span> <span class="mi">8080</span>
</pre></div>
</div>
<p>We also need to deploy a mongoDb. We will use the standard mongoDb image from dockerhub.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">apps</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="n">mongodb</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">oda</span><span class="o">.</span><span class="n">tmforum</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">componentName</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="p">{{</span><span class="o">.</span><span class="n">Values</span><span class="o">.</span><span class="n">component</span><span class="o">.</span><span class="n">type</span><span class="p">}}</span>
    <span class="n">app</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="n">mongodb</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">replicas</span><span class="p">:</span> <span class="mi">1</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">matchLabels</span><span class="p">:</span>
      <span class="n">app</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="n">mongodb</span>
  <span class="n">template</span><span class="p">:</span>
    <span class="n">metadata</span><span class="p">:</span>
      <span class="n">labels</span><span class="p">:</span>
        <span class="n">app</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="n">mongodb</span>
    <span class="n">spec</span><span class="p">:</span>
      <span class="n">containers</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="n">mongodb</span>
        <span class="n">image</span><span class="p">:</span> <span class="n">mongo</span><span class="p">:</span><span class="n">latest</span>
        <span class="n">ports</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="n">mongodb</span>
          <span class="n">containerPort</span><span class="p">:</span> <span class="mi">27017</span>
        <span class="n">volumeMounts</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="n">mongodb</span><span class="o">-</span><span class="n">pv</span><span class="o">-</span><span class="n">storage</span>
          <span class="n">mountPath</span><span class="p">:</span> <span class="s2">&quot;/data/db&quot;</span>
      <span class="n">volumes</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="n">mongodb</span><span class="o">-</span><span class="n">pv</span><span class="o">-</span><span class="n">storage</span>
        <span class="n">persistentVolumeClaim</span><span class="p">:</span>
          <span class="n">claimName</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="n">mongodb</span><span class="o">-</span><span class="n">pv</span><span class="o">-</span><span class="n">claim</span>
</pre></div>
</div>
<p>The mongoDb requires a persistentVolume and so we create a persistentVolumeClaim template <code class="docutils literal notranslate"><span class="pre">persistentVolumeClaim-mongodb.yaml</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kind</span><span class="p">:</span> <span class="n">PersistentVolumeClaim</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="n">mongodb</span><span class="o">-</span><span class="n">pv</span><span class="o">-</span><span class="n">claim</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">oda</span><span class="o">.</span><span class="n">tmforum</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">componentName</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="p">{{</span><span class="o">.</span><span class="n">Values</span><span class="o">.</span><span class="n">component</span><span class="o">.</span><span class="n">type</span><span class="p">}}</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">storageClassName</span><span class="p">:</span> <span class="n">default</span><span class="o">-</span><span class="n">st1</span>
  <span class="n">accessModes</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">ReadWriteOnce</span>
  <span class="n">resources</span><span class="p">:</span>
    <span class="n">requests</span><span class="p">:</span>
      <span class="n">storage</span><span class="p">:</span> <span class="mi">5</span><span class="n">Gi</span> 
</pre></div>
</div>
<p>We need to make the mongoDb available to the nodejs productcatalogapi image, so we create a Kubernetes Service resource in <code class="docutils literal notranslate"><span class="pre">service-mongodb.yaml</span></code>. Note the service matches the connection url we created in step 3.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="n">mongodb</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">oda</span><span class="o">.</span><span class="n">tmforum</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">componentName</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="p">{{</span><span class="o">.</span><span class="n">Values</span><span class="o">.</span><span class="n">component</span><span class="o">.</span><span class="n">type</span><span class="p">}}</span>
    <span class="n">app</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="n">mongodb</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">ports</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">port</span><span class="p">:</span> <span class="mi">27017</span>
    <span class="n">targetPort</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="n">mongodb</span>
    <span class="n">name</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="n">mongodb</span>
  <span class="nb">type</span><span class="p">:</span> <span class="n">NodePort</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="n">mongodb</span>
</pre></div>
</div>
<p>We need to expose the product catalog API using a Service as well in <code class="docutils literal notranslate"><span class="pre">service-productcatalogapi.yaml</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="n">productcatalogapi</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="n">productcatalogapi</span>
    <span class="n">oda</span><span class="o">.</span><span class="n">tmforum</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">componentName</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="p">{{</span><span class="o">.</span><span class="n">Values</span><span class="o">.</span><span class="n">component</span><span class="o">.</span><span class="n">type</span><span class="p">}}</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">ports</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">port</span><span class="p">:</span> <span class="mi">8080</span>
    <span class="n">targetPort</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="n">productcatalogapi</span>
    <span class="n">name</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="n">productcatalogapi</span>
  <span class="nb">type</span><span class="p">:</span> <span class="n">NodePort</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">app</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="n">productcatalogapi</span>
</pre></div>
</div>
<p>We have created all the Kubernetes resources to deploy the mongoDb and productcatalog nodejs containers and expose as services. The final step is to add the ODA-Component meta-data. This meta-data will be used at run-time to configure the canvas services. Create the code below in <code class="docutils literal notranslate"><span class="pre">component-productcatalog.yaml</span></code>.</p>
<p>This is a relatively simple component that just exposes one API as part of its <code class="docutils literal notranslate"><span class="pre">coreFunction</span></code>. Note that we have included the release name and component name in the root of the AI path (this is a good pattern to follow so that the API doesn’t conflict with any other components deployed in the same environment).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">oda</span><span class="o">.</span><span class="n">tmforum</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">v1alpha1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">component</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="p">{{</span><span class="o">.</span><span class="n">Values</span><span class="o">.</span><span class="n">component</span><span class="o">.</span><span class="n">type</span><span class="p">}}</span>
  <span class="n">labels</span><span class="p">:</span>
    <span class="n">oda</span><span class="o">.</span><span class="n">tmforum</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">componentName</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="p">{{</span><span class="o">.</span><span class="n">Values</span><span class="o">.</span><span class="n">component</span><span class="o">.</span><span class="n">type</span><span class="p">}}</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="nb">type</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Values</span><span class="o">.</span><span class="n">component</span><span class="o">.</span><span class="n">type</span><span class="p">}}</span>
  <span class="n">selector</span><span class="p">:</span>
    <span class="n">matchLabels</span><span class="p">:</span>
     <span class="n">oda</span><span class="o">.</span><span class="n">tmforum</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">componentName</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="p">{{</span><span class="o">.</span><span class="n">Values</span><span class="o">.</span><span class="n">component</span><span class="o">.</span><span class="n">type</span><span class="p">}}</span>
  <span class="n">componentKinds</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">group</span><span class="p">:</span> <span class="n">core</span>
      <span class="n">kind</span><span class="p">:</span> <span class="n">Service</span>    
    <span class="o">-</span> <span class="n">group</span><span class="p">:</span> <span class="n">core</span>
      <span class="n">kind</span><span class="p">:</span> <span class="n">PersistentVolumeClaim</span>
    <span class="o">-</span> <span class="n">group</span><span class="p">:</span> <span class="n">apps</span>
      <span class="n">kind</span><span class="p">:</span> <span class="n">Deployment</span>  
  <span class="n">version</span><span class="p">:</span> <span class="s2">&quot;0.0.1&quot;</span>
  <span class="n">description</span><span class="p">:</span> <span class="s2">&quot;Simple Product Catalog ODA-Component from Open-API reference implementation.&quot;</span> 
  <span class="n">maintainers</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Lester</span> <span class="n">Thomas</span>
      <span class="n">email</span><span class="p">:</span> <span class="n">lester</span><span class="o">.</span><span class="n">thomas</span><span class="nd">@vodafone</span><span class="o">.</span><span class="n">com</span>
  <span class="n">owners</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">Lester</span> <span class="n">Thomas</span>
      <span class="n">email</span><span class="p">:</span> <span class="n">lester</span><span class="o">.</span><span class="n">thomas</span><span class="nd">@vodafone</span><span class="o">.</span><span class="n">com</span>     
  <span class="n">coreFunction</span><span class="p">:</span>
    <span class="n">exposedAPIs</span><span class="p">:</span> 
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">productcatalogmanagement</span>
      <span class="n">specification</span><span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">tmforum</span><span class="o">-</span><span class="n">apis</span><span class="o">/</span><span class="n">TMF620_ProductCatalog</span><span class="o">/</span><span class="n">master</span><span class="o">/</span><span class="n">TMF620</span><span class="o">-</span><span class="n">ProductCatalog</span><span class="o">-</span><span class="n">v4</span><span class="o">.</span><span class="mf">0.0</span><span class="o">.</span><span class="n">swagger</span><span class="o">.</span><span class="n">json</span>
      <span class="n">implementation</span><span class="p">:</span> <span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="n">productcatalogapi</span>
      <span class="n">path</span><span class="p">:</span> <span class="o">/</span><span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="p">{{</span><span class="o">.</span><span class="n">Values</span><span class="o">.</span><span class="n">component</span><span class="o">.</span><span class="n">type</span><span class="p">}}</span><span class="o">/</span><span class="n">tmf</span><span class="o">-</span><span class="n">api</span><span class="o">/</span><span class="n">productCatalogManagement</span><span class="o">/</span><span class="n">v4</span>
      <span class="n">developerUI</span><span class="p">:</span> <span class="o">/</span><span class="p">{{</span><span class="o">.</span><span class="n">Release</span><span class="o">.</span><span class="n">Name</span><span class="p">}}</span><span class="o">-</span><span class="p">{{</span><span class="o">.</span><span class="n">Values</span><span class="o">.</span><span class="n">component</span><span class="o">.</span><span class="n">type</span><span class="p">}}</span><span class="o">/</span><span class="n">tmf</span><span class="o">-</span><span class="n">api</span><span class="o">/</span><span class="n">productCatalogManagement</span><span class="o">/</span><span class="n">v4</span>
      <span class="n">port</span><span class="p">:</span> <span class="mi">8080</span>
    <span class="n">dependantAPIs</span><span class="p">:</span> <span class="p">[]</span>
  <span class="n">eventNotification</span><span class="p">:</span>
    <span class="n">publishedEvents</span><span class="p">:</span> <span class="p">[]</span>
    <span class="n">subscribedEvents</span><span class="p">:</span> <span class="p">[]</span>
  <span class="n">management</span><span class="p">:</span> <span class="p">[]</span>
  <span class="n">security</span><span class="p">:</span>
    <span class="n">securitySchemes</span><span class="p">:</span> <span class="p">[]</span>
</pre></div>
</div>
<p>Finally we have to create the parameters in the <code class="docutils literal notranslate"><span class="pre">values.yaml</span></code> file. Since we have parameterized just 1 value, our values.yaml file will look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Default values for productcatalog.</span>
<span class="c1"># This is a YAML-formatted file.</span>
<span class="c1"># Declare variables to be passed into your templates.</span>


<span class="n">component</span><span class="p">:</span>
  <span class="nb">type</span><span class="p">:</span> <span class="n">productcatalog</span>
</pre></div>
</div>
</div>
<div class="section" id="step-6-test-component-envelope-using-component-ctk">
<h2>Step 6. Test component envelope using component CTK<a class="headerlink" href="#step-6-test-component-envelope-using-component-ctk" title="Permalink to this headline">¶</a></h2>
<p>The CTK will operate against an instance of the component. We can generate a kubernetes manifest of an instance using the <code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">template</span> <span class="pre">[instance</span> <span class="pre">namme]</span> <span class="pre">[chart]</span></code> command. We can take the output of this command into a temporary file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">helm</span> <span class="n">template</span> <span class="n">test</span> <span class="n">productcatalog</span> <span class="o">&gt;</span> <span class="n">test</span><span class="o">-</span><span class="n">instance</span><span class="o">.</span><span class="n">component</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>If you examine the test-instance.component.yaml you will see all the kubernetes resources (deployments, services, persistentVolumeClaim) as well as a component resource. All the resources are labelled as belonging to the component. Also the component describes its core function (exposing a single API).</p>
<p>We can test that this component instance conforms to the ODA-Component standard by using the component CTK: Download the ODA-Component CTK from <a class="reference external" href="https://github.com/tmforum-oda/oda-component-ctk/">https://github.com/tmforum-oda/oda-component-ctk/</a>.</p>
<p>Within the opa-component-ctk folder, install the ctk.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">npm</span> <span class="n">install</span>
</pre></div>
</div>
<p>Then run the static ctk against the component envelope.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">npm</span> <span class="n">static</span> <span class="o">../</span><span class="n">oda</span><span class="o">-</span><span class="n">ca</span><span class="o">-</span><span class="n">docs</span><span class="o">/</span><span class="n">ODA</span><span class="o">-</span><span class="n">Component</span><span class="o">-</span><span class="n">Tutorial</span><span class="o">/</span><span class="n">test</span><span class="o">-</span><span class="n">instance</span><span class="o">.</span><span class="n">component</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>You shold get an output like the image below. If you receive any errors, fix the issue in the helm chart yaml file and try again.</p>
<p><img alt="CTK image" src="../../_images/ctksuccess.png" /></p>
</div>
<div class="section" id="step-7-deploy-the-component-envelope-into-open-digital-lab-canvas">
<h2>Step 7. Deploy the component envelope into Open Digital Lab canvas<a class="headerlink" href="#step-7-deploy-the-component-envelope-into-open-digital-lab-canvas" title="Permalink to this headline">¶</a></h2>
<p>Connect to the Open Digital Lab: Get the kubectl config from the rancher environment at https://rke.tmforum.org/c/c-85kcq/monitoring - click the Kubeconfig File button in the top right:</p>
<p><img alt="Rancher" src="../../_images/Rancher.png" /></p>
<p>Copy this into your <code class="docutils literal notranslate"><span class="pre">~/.kube/config</span></code> file.</p>
<p>You can test the connection using <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">all</span> <span class="pre">--namespace</span> <span class="pre">components</span></code>. (You should either see a message <code class="docutils literal notranslate"><span class="pre">No</span> <span class="pre">resources</span> <span class="pre">found</span> <span class="pre">in</span> <span class="pre">components</span> <span class="pre">namespace.</span></code> or you may retrieve a list of kubernetes resources).</p>
<p>To permanently save the namespace for all subsequent kubectl commands use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">config</span> <span class="nb">set</span><span class="o">-</span><span class="n">context</span> <span class="o">--</span><span class="n">current</span> <span class="o">--</span><span class="n">namespace</span><span class="o">=</span><span class="n">components</span>
</pre></div>
</div>
<p>Install the component using Helm:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">helm</span> <span class="n">install</span> <span class="n">test</span> <span class="n">productcatalog</span><span class="o">/</span> 
</pre></div>
</div>
<p>You can then view the component in <code class="docutils literal notranslate"><span class="pre">kubectl</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">get</span> <span class="n">components</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">components</span></code> will show all the deployed components including the details of exposed apis and a developer-ui (if supplied). Initially these details will be blank - the component may take a few seconds to fully deploy. Once deployed, it should look like:</p>
<p><img alt="get components" src="../../_images/kubectl-get-components.png" /></p>
<p>If you navigate to the root or the API (in a web browser or in postman), you should see the entrypoint of the API:</p>
<p><img alt="api entrypoint" src="../../_images/api-entrypoint.png" /></p>
<p>If you navigate to the developer-ui, you shold see the swagger-ui tool:</p>
<p><img alt="swagger ui" src="../../_images/swagger-ui.png" /></p>
<p>Finally, you can run the dynamic ctk against the component envelope.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">npm</span> <span class="n">dynamic</span> <span class="o">../</span><span class="n">oda</span><span class="o">-</span><span class="n">ca</span><span class="o">-</span><span class="n">docs</span><span class="o">/</span><span class="n">ODA</span><span class="o">-</span><span class="n">Component</span><span class="o">-</span><span class="n">Tutorial</span><span class="o">/</span><span class="n">test</span><span class="o">-</span><span class="n">instance</span><span class="o">.</span><span class="n">component</span><span class="o">.</span><span class="n">yaml</span>
</pre></div>
</div>
<p>You should get a result like the image below:</p>
<p><img alt="CTK image" src="../../_images/ctkdynamicsuccess.png" /></p>
</div>
<div class="section" id="issues-resolution">
<h2>ISSUES &amp; resolution<a class="headerlink" href="#issues-resolution" title="Permalink to this headline">¶</a></h2>
<ol class="simple">
<li><p>Kubernetes ingress expect a 200 response at the root of the API. Without this, they do not create an ingress and instead return a 503 error. I’ve created an additional ‘entrypoint’ middleware hook in the index.js. This returns an entrypoint (or homepage) response for the API (following the TMF630 Design Guidelines).</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="o">//</span> <span class="n">create</span> <span class="n">an</span> <span class="n">entrypoint</span>
  <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;app.use entrypoint&#39;</span><span class="p">);</span>
  <span class="n">app</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="n">swaggerDoc</span><span class="o">.</span><span class="n">basePath</span><span class="p">,</span> <span class="n">entrypointUtils</span><span class="o">.</span><span class="n">entrypoint</span><span class="p">);</span>
</pre></div>
</div>
<ol class="simple">
<li><p>Due to a node version issue (i think!) the generated API RI does not work on the latest v15 of node. I have created container based on node v10. The issue is with the fs.copyFileSync function: The v15 expects the third parameter to be an optional <code class="docutils literal notranslate"><span class="pre">mode</span></code> whilst the current implementation has a call-back error function.</p></li>
<li><p>api-docs are exposed at /api-docs which means that you cant host multiple apis on the same server. I’ve moved to host them at /tmf-api/productCatalogManagement/v4/api-docs instead (and the swagger-ui at /tmf-api/productCatalogManagement/v4/docs).</p></li>
<li><p>MongoDb url in productcatalogapi image needs to include the Release Name (for the instance of the component) - pass this as an Environment variable.</p></li>
<li><p>I’ve included the component name in the root of the API (so that you can deploy multiple instances of the API in the same server). For a Helm install with release name test, the api is deployed at: /test-productcatalog/tmf-api/productCatalogManagement/v4/</p></li>
</ol>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../ODAComponentDesignGuidelines.html" class="btn btn-neutral float-right" title="Design Guidelines to create a new ODA Component" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="../README.html" class="btn btn-neutral float-left" title="Introduction to the ODA-CA" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, TM Forum ODA-Component Accelerator project.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>